<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Skippy — Onboarding (Live)</title>
  <link href="https://fonts.googleapis.com/css2?family=Crimson+Pro:ital,wght@0,300;0,400;1,300;1,400&family=Inter:wght@300;400;500;600&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
  
  <!-- Google API Client -->
  <script src="https://apis.google.com/js/api.js"></script>
  <script src="https://accounts.google.com/gsi/client"></script>
  
  <style>
    :root {
      --void: #030305;
      --deep: #08080c;
      --gold: #c4a35a;
      --gold-bright: #d4b86a;
      --gold-glow: rgba(196, 163, 90, 0.4);
      --gold-dim: rgba(196, 163, 90, 0.15);
      --sage: #7a8c6a;
      --sage-dark: #5a6c4a;
      --sage-glow: rgba(122, 140, 106, 0.5);
      --cream: #f0ebe0;
      --text: #ffffff;
      --text-dim: rgba(255, 255, 255, 0.5);
      --text-faint: rgba(255, 255, 255, 0.25);
      --red: #c45a5a;
      --red-dim: rgba(196, 90, 90, 0.2);
    }

    * { margin: 0; padding: 0; box-sizing: border-box; }

    html, body {
      width: 100%;
      height: 100%;
      overflow: hidden;
    }

    body {
      font-family: 'Inter', -apple-system, sans-serif;
      background: var(--void);
      color: var(--text);
    }

    /* ============================================
       SETUP PANEL (shown first if no API keys)
       ============================================ */
    #setupPanel {
      position: fixed;
      inset: 0;
      background: var(--void);
      z-index: 1000;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 40px;
    }

    #setupPanel.hidden {
      display: none;
    }

    .setup-container {
      max-width: 600px;
      width: 100%;
    }

    .setup-container h1 {
      font-family: 'Crimson Pro', Georgia, serif;
      font-size: 32px;
      font-weight: 300;
      font-style: italic;
      color: var(--cream);
      margin-bottom: 16px;
    }

    .setup-container p {
      font-size: 14px;
      color: var(--text-dim);
      line-height: 1.7;
      margin-bottom: 32px;
    }

    .setup-container code {
      display: block;
      background: rgba(255, 255, 255, 0.05);
      border: 1px solid rgba(255, 255, 255, 0.1);
      border-radius: 8px;
      padding: 16px;
      font-family: 'JetBrains Mono', monospace;
      font-size: 12px;
      color: var(--gold);
      margin: 16px 0;
      white-space: pre-wrap;
      word-break: break-all;
    }

    .setup-input {
      width: 100%;
      padding: 14px 16px;
      background: rgba(255, 255, 255, 0.05);
      border: 1px solid rgba(255, 255, 255, 0.15);
      border-radius: 10px;
      font-family: 'JetBrains Mono', monospace;
      font-size: 13px;
      color: var(--text);
      margin-bottom: 12px;
    }

    .setup-input:focus {
      outline: none;
      border-color: var(--gold);
    }

    .setup-input::placeholder {
      color: var(--text-faint);
    }

    .setup-btn {
      padding: 14px 32px;
      background: var(--sage);
      border: none;
      border-radius: 10px;
      font-family: inherit;
      font-size: 14px;
      font-weight: 500;
      color: white;
      cursor: pointer;
      margin-top: 16px;
      transition: all 0.2s;
    }

    .setup-btn:hover {
      background: var(--sage-dark);
    }

    .setup-note {
      margin-top: 24px;
      padding: 16px;
      background: var(--gold-dim);
      border-radius: 10px;
      font-size: 13px;
      color: var(--gold);
      line-height: 1.6;
    }

    .setup-skip {
      display: block;
      margin-top: 24px;
      text-align: center;
      font-size: 13px;
      color: var(--text-faint);
      text-decoration: none;
      cursor: pointer;
    }

    .setup-skip:hover {
      color: var(--text-dim);
    }

    /* ============================================
       FULL SCREEN LAYERS
       ============================================ */
    .layer {
      position: fixed;
      inset: 0;
      pointer-events: none;
    }

    .bg-space {
      background: 
        radial-gradient(ellipse at 50% 0%, rgba(196, 163, 90, 0.03) 0%, transparent 50%),
        radial-gradient(ellipse at 0% 100%, rgba(122, 140, 106, 0.02) 0%, transparent 40%),
        radial-gradient(ellipse at 100% 100%, rgba(196, 163, 90, 0.02) 0%, transparent 40%),
        var(--void);
    }

    .bg-noise {
      opacity: 0.03;
      background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 256 256' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noise'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.9' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noise)'/%3E%3C/svg%3E");
    }

    .scanlines {
      background: repeating-linear-gradient(
        0deg,
        transparent,
        transparent 2px,
        rgba(0, 0, 0, 0.1) 2px,
        rgba(0, 0, 0, 0.1) 4px
      );
      opacity: 0.3;
    }

    .vignette {
      background: radial-gradient(ellipse at 50% 50%, transparent 40%, var(--void) 100%);
    }

    .particles {
      overflow: hidden;
    }

    .particle {
      position: absolute;
      width: 2px;
      height: 2px;
      background: var(--gold);
      border-radius: 50%;
      opacity: 0;
    }

    .scan-beam {
      position: fixed;
      left: 0;
      right: 0;
      height: 2px;
      background: linear-gradient(90deg, transparent, var(--gold), transparent);
      box-shadow: 0 0 20px var(--gold-glow), 0 0 60px var(--gold-glow);
      opacity: 0;
      top: 0;
    }

    .scan-beam.active {
      animation: scanDown 2s ease-in-out forwards;
    }

    @keyframes scanDown {
      0% { top: 0; opacity: 0; }
      10% { opacity: 1; }
      90% { opacity: 1; }
      100% { top: 100%; opacity: 0; }
    }

    /* ============================================
       SEQUENCES
       ============================================ */
    .sequence {
      position: fixed;
      inset: 0;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.8s ease;
    }

    .sequence.active {
      opacity: 1;
      pointer-events: auto;
    }

    /* ============================================
       SEQUENCE 0: Click to begin
       ============================================ */
    #seq0 {
      cursor: pointer;
      background: var(--void);
      z-index: 100;
    }

    #seq0 .prompt {
      font-size: 14px;
      letter-spacing: 6px;
      text-transform: uppercase;
      color: var(--text-dim);
      animation: pulse 3s ease-in-out infinite;
    }

    @keyframes pulse {
      0%, 100% { opacity: 0.4; }
      50% { opacity: 0.8; }
    }

    #seq0 .sound-hint {
      position: absolute;
      bottom: 80px;
      font-size: 13px;
      color: var(--text-faint);
      display: flex;
      align-items: center;
      gap: 10px;
    }

    /* ============================================
       SEQUENCE 1: Secure Connection
       ============================================ */
    #seq1 {
      padding: 10vh 10vw;
    }

    .init-text {
      font-family: 'JetBrains Mono', monospace;
      font-size: 13px;
      color: var(--gold);
      opacity: 0.9;
      line-height: 2.2;
      max-width: 600px;
    }

    .init-line {
      opacity: 0;
      transform: translateX(-10px);
    }

    .init-line.show {
      animation: initLineIn 0.3s ease forwards;
    }

    .init-line.success {
      color: var(--sage);
    }

    .init-line .checkmark {
      color: var(--sage);
      margin-left: 8px;
    }

    @keyframes initLineIn {
      to { opacity: 1; transform: translateX(0); }
    }

    .init-cursor {
      display: inline-block;
      width: 8px;
      height: 14px;
      background: var(--gold);
      margin-left: 4px;
      animation: blink 0.6s infinite;
    }

    @keyframes blink {
      50% { opacity: 0; }
    }

    /* ============================================
       SEQUENCE 2: Permissions
       ============================================ */
    #seq2 {
      padding: 6vh 8vw;
      overflow-y: auto;
    }

    .permissions-container {
      width: 100%;
      max-width: 700px;
      opacity: 0;
      transform: translateY(20px);
    }

    .permissions-container.show {
      animation: fadeInUp 0.6s ease forwards;
    }

    @keyframes fadeInUp {
      to { opacity: 1; transform: translateY(0); }
    }

    .permissions-header {
      text-align: center;
      margin-bottom: 48px;
    }

    .permissions-header h1 {
      font-family: 'Crimson Pro', Georgia, serif;
      font-size: 36px;
      font-weight: 300;
      font-style: italic;
      color: var(--cream);
      margin-bottom: 12px;
    }

    .permissions-header p {
      font-size: 14px;
      color: var(--text-dim);
    }

    .permissions-section {
      margin-bottom: 32px;
    }

    .section-label {
      font-family: 'JetBrains Mono', monospace;
      font-size: 10px;
      letter-spacing: 2px;
      text-transform: uppercase;
      color: var(--gold);
      margin-bottom: 16px;
      padding-left: 4px;
    }

    .permission-card {
      display: flex;
      align-items: center;
      justify-content: space-between;
      background: rgba(255, 255, 255, 0.02);
      border: 1px solid rgba(255, 255, 255, 0.06);
      border-radius: 16px;
      padding: 20px 24px;
      margin-bottom: 12px;
      transition: all 0.3s ease;
    }

    .permission-card:hover {
      background: rgba(255, 255, 255, 0.04);
      border-color: rgba(255, 255, 255, 0.1);
    }

    .permission-card.connected {
      background: rgba(122, 140, 106, 0.1);
      border-color: rgba(122, 140, 106, 0.3);
    }

    .permission-card.connecting {
      border-color: var(--gold);
      box-shadow: 0 0 20px var(--gold-dim);
    }

    .permission-card.denied {
      background: var(--red-dim);
      border-color: var(--red);
    }

    .permission-info {
      display: flex;
      align-items: center;
      gap: 16px;
    }

    .permission-icon {
      width: 44px;
      height: 44px;
      border-radius: 12px;
      background: rgba(255, 255, 255, 0.05);
      display: flex;
      align-items: center;
      justify-content: center;
      color: var(--text-dim);
      transition: all 0.3s;
    }

    .permission-card.connected .permission-icon {
      background: var(--sage);
      color: white;
    }

    .permission-details h3 {
      font-size: 15px;
      font-weight: 500;
      color: var(--text);
      margin-bottom: 4px;
    }

    .permission-details p {
      font-size: 13px;
      color: var(--text-dim);
    }

    .permission-card.connected .permission-details p {
      color: var(--sage);
    }

    .permission-btn {
      padding: 10px 20px;
      background: rgba(255, 255, 255, 0.08);
      border: 1px solid rgba(255, 255, 255, 0.15);
      border-radius: 10px;
      font-family: inherit;
      font-size: 13px;
      font-weight: 500;
      color: var(--text);
      cursor: pointer;
      transition: all 0.2s;
      min-width: 100px;
    }

    .permission-btn:hover {
      background: rgba(255, 255, 255, 0.12);
      border-color: rgba(255, 255, 255, 0.25);
    }

    .permission-btn.primary {
      background: var(--sage);
      border-color: var(--sage);
      color: white;
    }

    .permission-btn.primary:hover {
      background: var(--sage-dark);
    }

    .permission-btn.connected {
      background: transparent;
      border-color: var(--sage);
      color: var(--sage);
      pointer-events: none;
    }

    .permission-btn.connecting {
      background: var(--gold-dim);
      border-color: var(--gold);
      color: var(--gold);
      pointer-events: none;
    }

    .permissions-progress {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-top: 32px;
      padding-top: 24px;
      border-top: 1px solid rgba(255, 255, 255, 0.06);
    }

    .progress-text {
      font-size: 13px;
      color: var(--text-dim);
    }

    .progress-text span {
      color: var(--gold);
      font-weight: 500;
    }

    .continue-btn {
      padding: 14px 32px;
      background: var(--sage);
      border: none;
      border-radius: 12px;
      font-family: inherit;
      font-size: 14px;
      font-weight: 500;
      color: white;
      cursor: pointer;
      opacity: 0.4;
      pointer-events: none;
      transition: all 0.3s;
    }

    .continue-btn.enabled {
      opacity: 1;
      pointer-events: auto;
    }

    .continue-btn.enabled:hover {
      background: var(--sage-dark);
      transform: translateY(-2px);
    }

    /* ============================================
       SEQUENCE 3: Analyzing
       ============================================ */
    #seq3 {
      padding: 10vh 10vw;
    }

    .analyzing-container {
      max-width: 600px;
      width: 100%;
    }

    .analyzing-header {
      font-family: 'Crimson Pro', Georgia, serif;
      font-size: 28px;
      font-weight: 300;
      font-style: italic;
      color: var(--cream);
      margin-bottom: 48px;
      opacity: 0;
    }

    .analyzing-header.show {
      animation: fadeInUp 0.6s ease forwards;
    }

    .analyze-line {
      font-family: 'JetBrains Mono', monospace;
      font-size: 13px;
      color: var(--gold);
      opacity: 0;
      line-height: 2.4;
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .analyze-line.show {
      animation: initLineIn 0.4s ease forwards;
    }

    .analyze-line .spinner {
      width: 12px;
      height: 12px;
      border: 2px solid var(--gold-dim);
      border-top-color: var(--gold);
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
    }

    .analyze-line.complete .spinner {
      display: none;
    }

    .analyze-line.complete::before {
      content: '✓';
      color: var(--sage);
      font-size: 14px;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    .analyze-progress {
      margin-top: 48px;
      height: 2px;
      background: rgba(255, 255, 255, 0.1);
      border-radius: 2px;
      overflow: hidden;
      opacity: 0;
    }

    .analyze-progress.show {
      animation: fadeInUp 0.4s ease forwards;
    }

    .analyze-progress-bar {
      height: 100%;
      background: linear-gradient(90deg, var(--gold), var(--sage));
      width: 0%;
      transition: width 0.3s ease;
    }

    /* ============================================
       SEQUENCE 4: I Know You
       ============================================ */
    #seq4, #seq5 {
      padding: 8vh 12vw;
      align-items: flex-start;
      justify-content: flex-start;
      overflow-y: auto;
    }
    
    .capability-header {
      color: var(--gold) !important;
      font-style: italic;
      margin-bottom: 32px !important;
    }

    .skippy-speaks {
      max-width: 900px;
    }

    .skippy-line {
      font-family: 'Crimson Pro', Georgia, serif;
      font-size: 28px;
      font-weight: 300;
      line-height: 1.8;
      color: var(--cream);
      margin-bottom: 20px;
      opacity: 0;
    }

    .skippy-line.show {
      animation: lineReveal 0.8s ease forwards;
    }

    @keyframes lineReveal {
      0% { opacity: 0; transform: translateY(20px); filter: blur(4px); }
      100% { opacity: 1; transform: translateY(0); filter: blur(0); }
    }

    .skippy-line em {
      font-style: italic;
      color: var(--gold-bright);
    }

    .skippy-line .highlight {
      color: var(--gold);
      font-weight: 400;
    }

    .skippy-line .data {
      display: inline-block;
      padding: 2px 10px;
      background: var(--gold-dim);
      border-radius: 6px;
      font-family: 'JetBrains Mono', monospace;
      font-size: 15px;
      color: var(--gold);
    }

    .skippy-line.creepy {
      font-size: 24px;
      color: var(--text-dim);
      margin-top: 24px;
    }

    .skippy-line.finale {
      font-size: 32px;
      margin-top: 32px;
      color: var(--gold-bright);
    }

    /* ============================================
       SEQUENCE 5: Proactive Demos
       ============================================ */
    #seq5 {
      padding: 6vh 8vw;
    }

    .demo-card {
      width: 100%;
      max-width: 800px;
      background: rgba(255, 255, 255, 0.02);
      border: 1px solid rgba(255, 255, 255, 0.06);
      border-radius: 24px;
      padding: 40px 48px;
      opacity: 0;
      transform: translateY(30px);
    }

    .demo-card.show {
      animation: cardIn 0.8s ease forwards;
    }

    @keyframes cardIn {
      to { opacity: 1; transform: translateY(0); }
    }

    .demo-source {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 6px 12px;
      background: var(--gold-dim);
      border-radius: 6px;
      font-family: 'JetBrains Mono', monospace;
      font-size: 10px;
      letter-spacing: 1px;
      text-transform: uppercase;
      color: var(--gold);
      margin-bottom: 20px;
    }

    .demo-source::before {
      content: '';
      width: 6px;
      height: 6px;
      background: var(--gold);
      border-radius: 50%;
      animation: dotPulse 2s infinite;
    }

    @keyframes dotPulse {
      0%, 100% { opacity: 1; transform: scale(1); }
      50% { opacity: 0.5; transform: scale(0.8); }
    }

    .demo-message {
      font-family: 'Crimson Pro', Georgia, serif;
      font-size: 24px;
      font-weight: 300;
      line-height: 1.6;
      color: var(--cream);
      margin-bottom: 28px;
    }

    .demo-message .highlight {
      color: var(--gold);
    }

    .demo-insight {
      font-size: 13px;
      color: var(--text-dim);
      line-height: 1.8;
      padding: 16px 20px;
      background: rgba(255, 255, 255, 0.02);
      border-radius: 12px;
      border-left: 3px solid var(--gold-dim);
    }

    .demo-insight strong {
      color: var(--gold);
      font-weight: 500;
    }

    .demo-actions {
      display: flex;
      gap: 12px;
      margin-top: 32px;
    }

    .demo-btn {
      padding: 14px 28px;
      background: var(--sage);
      border: none;
      border-radius: 12px;
      font-family: inherit;
      font-size: 14px;
      font-weight: 500;
      color: white;
      cursor: pointer;
      transition: all 0.2s;
    }

    .demo-btn:hover {
      background: var(--sage-dark);
      transform: translateY(-2px);
    }

    .demo-btn-ghost {
      background: transparent;
      border: 1px solid var(--text-faint);
      color: var(--text-dim);
    }

    .demo-btn-ghost:hover {
      background: rgba(255, 255, 255, 0.05);
      border-color: var(--text-dim);
      color: var(--text);
    }

    .demo-counter {
      position: absolute;
      bottom: 48px;
      left: 50%;
      transform: translateX(-50%);
      display: flex;
      gap: 8px;
    }

    .demo-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: rgba(255, 255, 255, 0.2);
      transition: all 0.3s;
    }

    .demo-dot.active {
      background: var(--gold);
      transform: scale(1.2);
    }

    .demo-dot.done {
      background: var(--sage);
    }

    /* ============================================
       SEQUENCE 6: The Promise
       ============================================ */
    #seq6 {
      text-align: center;
    }

    .promise-text {
      font-family: 'Crimson Pro', Georgia, serif;
      font-size: 44px;
      font-weight: 300;
      font-style: italic;
      color: var(--cream);
      max-width: 700px;
      line-height: 1.5;
      opacity: 0;
    }

    .promise-text.show {
      animation: promiseIn 1.5s ease forwards;
    }

    @keyframes promiseIn {
      0% { opacity: 0; transform: scale(0.95); filter: blur(10px); }
      100% { opacity: 1; transform: scale(1); filter: blur(0); }
    }

    .promise-sub {
      font-size: 18px;
      color: var(--text-dim);
      margin-top: 32px;
      max-width: 600px;
      line-height: 1.7;
      opacity: 0;
    }

    .promise-sub.show {
      animation: lineReveal 0.8s ease forwards;
    }

    /* ============================================
       SEQUENCE 7: Welcome
       ============================================ */
    #seq7 {
      text-align: center;
    }

    .welcome-logo {
      font-family: 'Crimson Pro', Georgia, serif;
      font-style: italic;
      font-size: 100px;
      font-weight: 300;
      color: var(--cream);
      margin-bottom: 12px;
      opacity: 0;
      transform: translateY(30px);
    }

    .welcome-logo.show {
      animation: logoIn 1.2s cubic-bezier(0.16, 1, 0.3, 1) forwards;
    }

    @keyframes logoIn {
      to { opacity: 1; transform: translateY(0); }
    }

    .welcome-tagline {
      font-size: 16px;
      color: var(--text-dim);
      margin-bottom: 56px;
      opacity: 0;
    }

    .welcome-tagline.show {
      animation: lineReveal 0.8s ease forwards 0.3s;
    }

    .welcome-greeting {
      font-family: 'Crimson Pro', Georgia, serif;
      font-size: 26px;
      font-weight: 300;
      color: var(--gold-bright);
      margin-bottom: 48px;
      opacity: 0;
    }

    .welcome-greeting.show {
      animation: lineReveal 0.8s ease forwards 0.6s;
    }

    .begin-btn {
      padding: 20px 64px;
      background: linear-gradient(135deg, var(--sage), var(--sage-dark));
      border: none;
      border-radius: 14px;
      font-family: inherit;
      font-size: 16px;
      font-weight: 500;
      color: white;
      cursor: pointer;
      opacity: 0;
      transform: translateY(20px);
      transition: all 0.3s ease;
      box-shadow: 0 8px 40px var(--sage-glow);
    }

    .begin-btn.show {
      animation: lineReveal 0.8s ease forwards 0.9s;
    }

    .begin-btn:hover {
      transform: translateY(-3px);
      box-shadow: 0 12px 50px var(--sage-glow);
    }

    .shortcut-display {
      margin-top: 64px;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 12px;
      opacity: 0;
    }

    .shortcut-display.show {
      animation: lineReveal 0.8s ease forwards 1.5s;
    }

    .key {
      padding: 12px 18px;
      background: rgba(255, 255, 255, 0.05);
      border: 1px solid rgba(255, 255, 255, 0.12);
      border-radius: 10px;
      font-family: 'JetBrains Mono', monospace;
      font-size: 14px;
      color: var(--text-dim);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
    }

    .shortcut-label {
      font-size: 14px;
      color: var(--text-faint);
      margin-left: 8px;
    }

    /* Loading overlay */
    .loading-overlay {
      position: fixed;
      inset: 0;
      background: rgba(3, 3, 5, 0.9);
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      z-index: 2000;
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.3s;
    }

    .loading-overlay.active {
      opacity: 1;
      pointer-events: auto;
    }

    .loading-spinner {
      width: 40px;
      height: 40px;
      border: 3px solid var(--gold-dim);
      border-top-color: var(--gold);
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
      margin-bottom: 24px;
    }

    .loading-text {
      font-family: 'JetBrains Mono', monospace;
      font-size: 13px;
      color: var(--gold);
    }
  </style>
</head>
<body>

  <!-- AUDIO -->
  <audio id="music" loop>
    <source src="should-i-stay.mp3" type="audio/mpeg">
  </audio>

  <!-- SETUP PANEL -->
  <div id="setupPanel">
    <div class="setup-container">
      <h1>Setup Required</h1>
      <p>To run the live onboarding with real data, you need a Google OAuth Client ID. This lets Skippy access your calendar and email.</p>
      
      <div class="setup-note">
        <strong>You already have a Web Application OAuth set up!</strong><br><br>
        Just make sure your Google Cloud Console has these <strong>Authorized JavaScript Origins</strong>:<br>
        • <code style="display: inline; padding: 2px 6px; margin: 0;">http://localhost:8080</code><br>
        • <code style="display: inline; padding: 2px 6px; margin: 0;">http://127.0.0.1:8080</code><br><br>
        Then paste your existing Google Client ID below.
      </div>

      <input type="text" class="setup-input" id="clientIdInput" placeholder="Your Google Client ID (e.g., xxxxx.apps.googleusercontent.com)">
      
      <input type="text" class="setup-input" id="anthropicKeyInput" placeholder="Anthropic API Key (for behavioral analysis)..." value="">
      
      <button class="setup-btn" onclick="saveSetup()">Start Onboarding</button>
      
      <a class="setup-skip" onclick="skipSetup()">Skip setup and use demo data →</a>
    </div>
  </div>

  <!-- LOADING OVERLAY -->
  <div class="loading-overlay" id="loadingOverlay">
    <div class="loading-spinner"></div>
    <div class="loading-text" id="loadingText">Connecting to Google...</div>
  </div>

  <!-- BACKGROUND LAYERS -->
  <div class="layer bg-space"></div>
  <div class="layer bg-noise"></div>
  <div class="layer particles" id="particles"></div>
  <div class="layer scanlines"></div>
  <div class="layer vignette"></div>
  <div class="scan-beam" id="scanBeam"></div>

  <!-- SEQUENCE 0: Click to begin -->
  <div class="sequence" id="seq0" onclick="begin()">
    <div class="prompt">Click anywhere to begin</div>
    <div class="sound-hint">
      <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"/>
        <path d="M15.54 8.46a5 5 0 0 1 0 7.07"/>
        <path d="M19.07 4.93a10 10 0 0 1 0 14.14"/>
      </svg>
      Sound on for the best experience
    </div>
  </div>

  <!-- SEQUENCE 1: Secure Connection -->
  <div class="sequence" id="seq1">
    <div class="init-text" id="initText"></div>
  </div>

  <!-- SEQUENCE 2: Permissions -->
  <div class="sequence" id="seq2">
    <div class="permissions-container" id="permissionsContainer">
      <div class="permissions-header">
        <h1>To know you, I need access.</h1>
        <p>Everything stays on your device. Your data never leaves.</p>
      </div>

      <div class="permissions-section">
        <div class="section-label">Browser Permissions</div>
        
        <div class="permission-card" id="perm-location">
          <div class="permission-info">
            <div class="permission-icon">
              <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                <path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"/>
                <circle cx="12" cy="10" r="3"/>
              </svg>
            </div>
            <div class="permission-details">
              <h3>Location</h3>
              <p>Know where you are for context</p>
            </div>
          </div>
          <button class="permission-btn" onclick="requestLocation()">Enable</button>
        </div>

        <div class="permission-card" id="perm-mic">
          <div class="permission-info">
            <div class="permission-icon">
              <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                <path d="M12 1a3 3 0 0 0-3 3v8a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3z"/>
                <path d="M19 10v2a7 7 0 0 1-14 0v-2"/>
                <line x1="12" y1="19" x2="12" y2="23"/>
                <line x1="8" y1="23" x2="16" y2="23"/>
              </svg>
            </div>
            <div class="permission-details">
              <h3>Microphone</h3>
              <p>Voice commands and dictation</p>
            </div>
          </div>
          <button class="permission-btn" onclick="requestMicrophone()">Enable</button>
        </div>

        <div class="permission-card" id="perm-notifications">
          <div class="permission-info">
            <div class="permission-icon">
              <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                <path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9"/>
                <path d="M13.73 21a2 2 0 0 1-3.46 0"/>
              </svg>
            </div>
            <div class="permission-details">
              <h3>Notifications</h3>
              <p>Proactive alerts and reminders</p>
            </div>
          </div>
          <button class="permission-btn" onclick="requestNotifications()">Enable</button>
        </div>
      </div>

      <div class="permissions-section">
        <div class="section-label">Connect Your Accounts</div>
        
        <div class="permission-card" id="perm-google">
          <div class="permission-info">
            <div class="permission-icon">
              <svg width="22" height="22" viewBox="0 0 24 24" fill="currentColor">
                <path d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z" fill="#4285F4"/>
                <path d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z" fill="#34A853"/>
                <path d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z" fill="#FBBC05"/>
                <path d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z" fill="#EA4335"/>
              </svg>
            </div>
            <div class="permission-details">
              <h3>Google Account</h3>
              <p>Calendar and Email access</p>
            </div>
          </div>
          <button class="permission-btn primary" onclick="connectGoogle()">Connect</button>
        </div>
      </div>

      <div class="permissions-progress">
        <div class="progress-text"><span id="connectedCount">0</span> of 4 connected</div>
        <button class="continue-btn" id="continueBtn" onclick="finishPermissions()">Continue</button>
      </div>
    </div>
  </div>

  <!-- SEQUENCE 3: Analyzing -->
  <div class="sequence" id="seq3">
    <div class="analyzing-container">
      <div class="analyzing-header" id="analyzingHeader">Learning who you are...</div>
      <div id="analyzeLines"></div>
      <div class="analyze-progress" id="analyzeProgress">
        <div class="analyze-progress-bar" id="analyzeProgressBar"></div>
      </div>
    </div>
  </div>

  <!-- SEQUENCE 4: I Know You -->
  <div class="sequence" id="seq4">
    <div class="skippy-speaks" id="skippySpeaks"></div>
  </div>

  <!-- SEQUENCE 5: Proactive Demos -->
  <div class="sequence" id="seq5">
    <div class="skippy-speaks" id="capabilityContainer">
      <div class="skippy-line capability-header" id="capabilitiesHeader">Here's what I can do for you.</div>
      <div id="capabilityLines"></div>
    </div>
  </div>

  <!-- SEQUENCE 6: The Promise -->
  <div class="sequence" id="seq6">
    <div class="promise-text" id="promiseText"></div>
    <div class="promise-sub" id="promiseSub"></div>
  </div>

  <!-- SEQUENCE 7: Welcome -->
  <div class="sequence" id="seq7">
    <div class="welcome-logo" id="welcomeLogo">Skippy</div>
    <div class="welcome-tagline" id="welcomeTagline">The last assistant you'll ever need</div>
    <div class="welcome-greeting" id="welcomeGreeting">Welcome home.</div>
    <button class="begin-btn" id="beginBtn" onclick="finish()">Enter</button>
    <div class="shortcut-display" id="shortcutDisplay">
      <span class="key">⌥</span>
      <span style="color: var(--text-faint);">+</span>
      <span class="key">Space</span>
      <span class="shortcut-label">to summon me anytime</span>
    </div>
  </div>

  <script>
    // ============================================
    // CONFIGURATION
    // ============================================
    let CONFIG = {
      // Your Google Client ID - hardcoded for testing
      GOOGLE_CLIENT_ID: localStorage.getItem('skippy_google_client_id') || '646878626332-kqmveh6mau3c5rve5m46m3s52nfjt5ii.apps.googleusercontent.com',
      ANTHROPIC_API_KEY: localStorage.getItem('skippy_anthropic_key') || '',
      SCOPES: 'https://www.googleapis.com/auth/calendar.readonly https://www.googleapis.com/auth/gmail.readonly https://www.googleapis.com/auth/userinfo.profile https://www.googleapis.com/auth/userinfo.email'
    };

    // ============================================
    // STATE
    // ============================================
    let useDemoData = false;
    let tokenClient = null;
    let accessToken = null;
    
    let permissionsGranted = {
      location: false,
      mic: false,
      notifications: false,
      google: false
    };

    let userData = {
      name: '',
      email: '',
      location: null,
      calendar: {
        events: [],
        totalEvents: 0
      },
      email: {
        threads: [],
        totalThreads: 0,
        unreadCount: 0
      },
      insights: []
    };

    // ============================================
    // SETUP
    // ============================================
    function checkSetup() {
      if (CONFIG.GOOGLE_CLIENT_ID) {
        document.getElementById('setupPanel').classList.add('hidden');
        document.getElementById('seq0').classList.add('active');
        initGoogleClient();
        // Try to start music (may be blocked by browser until user interaction)
        startBackgroundMusic();
      }
      
      // Pre-fill if we have stored values
      if (CONFIG.GOOGLE_CLIENT_ID) {
        document.getElementById('clientIdInput').value = CONFIG.GOOGLE_CLIENT_ID;
      }
      if (CONFIG.ANTHROPIC_API_KEY) {
        document.getElementById('anthropicKeyInput').value = CONFIG.ANTHROPIC_API_KEY;
      }
    }

    function saveSetup() {
      const clientId = document.getElementById('clientIdInput').value.trim();
      const anthropicKey = document.getElementById('anthropicKeyInput').value.trim();
      
      if (!clientId) {
        alert('Please enter a Google Client ID');
        return;
      }

      CONFIG.GOOGLE_CLIENT_ID = clientId;
      CONFIG.ANTHROPIC_API_KEY = anthropicKey;
      
      localStorage.setItem('skippy_google_client_id', clientId);
      if (anthropicKey) {
        localStorage.setItem('skippy_anthropic_key', anthropicKey);
      }

      // Start music on user interaction
      startBackgroundMusic();

      document.getElementById('setupPanel').classList.add('hidden');
      document.getElementById('seq0').classList.add('active');
      initGoogleClient();
    }

    function skipSetup() {
      useDemoData = true;
      
      // Start music on user interaction
      startBackgroundMusic();
      
      // Still initialize Google client since we have the Client ID hardcoded
      initGoogleClient();
      
      document.getElementById('setupPanel').classList.add('hidden');
      document.getElementById('seq0').classList.add('active');
      
      // Load demo data
      userData = {
        name: 'Josh',
        email: 'josh@example.com',
        location: { city: 'San Francisco', timezone: 'PST' },
        calendar: {
          events: [
            { summary: 'Q4 Roadmap Review', start: new Date(Date.now() + 2*24*60*60*1000), attendees: ['sarah@company.com', 'mike@company.com'] },
            { summary: '1:1 with Sarah', start: new Date(Date.now() + 1*24*60*60*1000), attendees: ['sarah@company.com'] },
            { summary: 'Investor Call', start: new Date(Date.now() + 3*24*60*60*1000), attendees: ['partner@vc.com'] }
          ],
          totalEvents: 847
        },
        email: {
          threads: [
            { subject: 'Re: Series A Term Sheet', from: 'mark@sequoia.com', date: new Date(Date.now() - 3*24*60*60*1000), unread: true },
            { subject: 'Your DoorDash order', from: 'no-reply@doordash.com', date: new Date(Date.now() - 1*24*60*60*1000) },
            { subject: 'Meeting follow-up', from: 'sarah@company.com', date: new Date(Date.now() - 2*24*60*60*1000) }
          ],
          totalThreads: 12439,
          unreadCount: 47
        },
        insights: [
          "I know you start work at <span class='data'>8:47am</span> — but Mondays you're up at <span class='data'>6:12am</span>. You front-load your week.",
          "I know your emails average <span class='data'>47 words</span>. You're 3× more concise than most people.",
          "I know you respond to <span class='highlight'>investors</span> within 8 minutes, but <span class='highlight'>recruiters</span> wait 5 days.",
          "I know you've double-booked yourself <span class='data'>7 times</span> this month.",
          "I know you check email again at <span class='data'>10:45pm</span>. You can't fully disconnect.",
          "I know you protect <span class='highlight'>Thursday mornings</span>. That's your sacred time."
        ]
      };
    }

    // ============================================
    // GOOGLE OAUTH
    // ============================================
    function initGoogleClient() {
      if (!CONFIG.GOOGLE_CLIENT_ID) {
        console.log('No Google Client ID configured');
        return;
      }
      
      console.log('Initializing Google client with ID:', CONFIG.GOOGLE_CLIENT_ID.substring(0, 20) + '...');
      console.log('Scopes:', CONFIG.SCOPES);
      console.log('Origin:', window.location.origin);
      
      try {
        tokenClient = google.accounts.oauth2.initTokenClient({
          client_id: CONFIG.GOOGLE_CLIENT_ID,
          scope: CONFIG.SCOPES,
          callback: handleGoogleCallback,
          error_callback: (error) => {
            console.error('Google OAuth error callback:', error);
            const card = document.getElementById('perm-google');
            const btn = card.querySelector('.permission-btn');
            card.classList.remove('connecting');
            btn.classList.remove('connecting');
            btn.textContent = 'Retry';
            
            // Show helpful error
            let errorMsg = 'Google OAuth failed.\n\n';
            if (error.type === 'popup_closed') {
              errorMsg += 'The popup was closed. Please try again and complete the sign-in.';
            } else if (error.type === 'popup_blocked') {
              errorMsg += 'Popup was blocked. Please allow popups for this site.';
            } else if (error.message?.includes('origin')) {
              errorMsg += 'Origin mismatch. Add this to Google Cloud Console:\n' + window.location.origin;
            } else {
              errorMsg += 'Error: ' + (error.message || error.type || JSON.stringify(error));
              errorMsg += '\n\nMake sure these are in your Google Cloud Console:';
              errorMsg += '\n• JavaScript origin: ' + window.location.origin;
              errorMsg += '\n• Redirect URI: ' + window.location.origin;
            }
            alert(errorMsg);
          }
        });
        console.log('Google client initialized successfully');
      } catch (error) {
        console.error('Failed to init Google client:', error);
        alert('Failed to initialize Google client: ' + error.message);
      }
    }

    function connectGoogle() {
      // Log current origin for debugging
      console.log('Current origin:', window.location.origin);
      console.log('Current URL:', window.location.href);
      console.log('Client ID:', CONFIG.GOOGLE_CLIENT_ID?.substring(0, 30) + '...');
      
      // If no client ID configured, show setup instructions
      if (!CONFIG.GOOGLE_CLIENT_ID) {
        alert('Google Client ID not configured.\n\n1. Go to Google Cloud Console\n2. Create OAuth 2.0 Client ID (Web application)\n3. Add ' + window.location.origin + ' to authorized origins\n4. Refresh this page and enter your Client ID');
        return;
      }

      // Initialize token client if needed
      if (!tokenClient) {
        console.log('Token client not initialized, initializing now...');
        initGoogleClient();
      }

      if (!tokenClient) {
        alert('Failed to initialize Google client.\n\nMake sure you have added this origin to Google Cloud Console:\n' + window.location.origin);
        return;
      }

      const card = document.getElementById('perm-google');
      const btn = card.querySelector('.permission-btn');
      card.classList.add('connecting');
      btn.classList.add('connecting');
      btn.textContent = 'Connecting...';

      try {
        console.log('Requesting access token...');
        
        // Set a timeout to detect if callback never fires
        window.googleOAuthTimeout = setTimeout(() => {
          console.log('OAuth timeout - callback never fired');
          if (btn.textContent === 'Connecting...') {
            card.classList.remove('connecting');
            btn.classList.remove('connecting');
            btn.textContent = 'Retry';
            alert('OAuth timed out. The popup may have been blocked or closed.\n\nMake sure:\n1. Popups are allowed for this site\n2. You completed the Google sign-in\n3. Your origin is authorized: ' + window.location.origin);
          }
        }, 60000); // 60 second timeout
        
        tokenClient.requestAccessToken();
      } catch (error) {
        console.error('OAuth error:', error);
        card.classList.remove('connecting');
        btn.classList.remove('connecting');
        btn.textContent = 'Retry';
        alert('OAuth error: ' + error.message);
      }
    }

    async function handleGoogleCallback(response) {
      console.log('Google callback received:', response);
      
      // Clear timeout
      if (window.googleOAuthTimeout) {
        clearTimeout(window.googleOAuthTimeout);
      }
      
      const card = document.getElementById('perm-google');
      const btn = card.querySelector('.permission-btn');

      if (response.error) {
        console.error('Google OAuth error in response:', response);
        card.classList.remove('connecting');
        card.classList.add('denied');
        btn.classList.remove('connecting');
        btn.textContent = 'Denied';
        alert('Google OAuth error: ' + (response.error_description || response.error));
        return;
      }

      if (!response.access_token) {
        console.error('No access token in response:', response);
        card.classList.remove('connecting');
        btn.classList.remove('connecting');
        btn.textContent = 'Retry';
        alert('No access token received from Google');
        return;
      }

      accessToken = response.access_token;
      console.log('Access token received, fetching data...');
      
      // Show loading
      showLoading('Fetching your data...');

      try {
        // Fetch user profile
        console.log('Fetching profile...');
        const profile = await fetchGoogleProfile();
        console.log('Profile:', profile);
        userData.name = profile.given_name || profile.name?.split(' ')[0] || 'Friend';
        userData.email = profile.email;

        // Fetch calendar events
        showLoading('Reading your calendar...');
        console.log('Fetching calendar...');
        const calendarData = await fetchCalendarEvents();
        console.log('Calendar data:', calendarData);
        userData.calendar.events = calendarData.items || [];
        userData.calendar.totalEvents = calendarData.items?.length || 0;
        
        // Analyze calendar
        showLoading('Analyzing your meetings...');
        userData.calendar.analysis = analyzeCalendar(userData.calendar.events);
        console.log('Calendar analysis:', userData.calendar.analysis);

        // Fetch emails
        showLoading('Scanning your inbox...');
        console.log('Fetching emails...');
        const emailData = await fetchEmails();
        console.log('Email data:', emailData);
        userData.email.threads = emailData.messages || [];
        userData.email.totalThreads = emailData.resultSizeEstimate || 0;
        
        // Count unread
        console.log('Fetching unread count...');
        userData.email.unreadCount = await fetchUnreadCount();
        console.log('Unread count:', userData.email.unreadCount);

        // Fetch email details for DEEP analysis
        showLoading('Reading your conversations...');
        if (userData.email.threads && userData.email.threads.length > 0) {
          console.log('Fetching email details for', userData.email.threads.length, 'emails...');
          const messageIds = userData.email.threads.map(m => m.id);
          userData.email.details = await fetchEmailDetails(messageIds);
          console.log('Email details fetched:', userData.email.details?.length);
          
          showLoading('Understanding your relationships...');
          userData.email.analysis = analyzeEmails(userData.email.details || []);
          console.log('Email analysis complete:', userData.email.analysis);
        } else {
          console.log('No email threads found, skipping analysis');
          userData.email.details = [];
          userData.email.analysis = { 
            topRelationships: [], 
            relationships: {},
            receipts: [], 
            spendingByService: {}, 
            importantThreads: [], 
            totalAnalyzed: 0,
            writingStyle: null,
            workTopics: []
          };
        }

        hideLoading();

        // Mark as connected
        card.classList.remove('connecting');
        card.classList.add('connected');
        btn.classList.remove('connecting');
        btn.classList.add('connected');
        btn.textContent = 'Connected';
        
        permissionsGranted.google = true;
        updatePermissionProgress();

        console.log('✅ User data fully loaded:', userData);

      } catch (error) {
        hideLoading();
        console.error('❌ Error fetching Google data:', error);
        card.classList.remove('connecting');
        btn.classList.remove('connecting');
        btn.textContent = 'Retry';
        alert('Error fetching your data: ' + error.message + '\n\nCheck the browser console for details.');
      }
    }

    async function fetchGoogleProfile() {
      const response = await fetch('https://www.googleapis.com/oauth2/v2/userinfo', {
        headers: { Authorization: `Bearer ${accessToken}` }
      });
      return response.json();
    }

    async function fetchCalendarEvents() {
      const now = new Date().toISOString();
      const nextMonth = new Date(Date.now() + 30*24*60*60*1000).toISOString();
      
      const response = await fetch(
        `https://www.googleapis.com/calendar/v3/calendars/primary/events?timeMin=${now}&timeMax=${nextMonth}&maxResults=50&singleEvents=true&orderBy=startTime`,
        { headers: { Authorization: `Bearer ${accessToken}` } }
      );
      return response.json();
    }

    async function fetchEmails() {
      const response = await fetch(
        'https://www.googleapis.com/gmail/v1/users/me/messages?maxResults=100',
        { headers: { Authorization: `Bearer ${accessToken}` } }
      );
      return response.json();
    }

    async function fetchUnreadCount() {
      try {
        const response = await fetch(
          'https://www.googleapis.com/gmail/v1/users/me/messages?q=is:unread&maxResults=500',
          { headers: { Authorization: `Bearer ${accessToken}` } }
        );
        const data = await response.json();
        console.log('Unread response:', data);
        // resultSizeEstimate is the total count, messages is just the page
        return data.resultSizeEstimate || data.messages?.length || 0;
      } catch (e) {
        console.error('Error fetching unread count:', e);
        return 0;
      }
    }

    // Fetch detailed email metadata for analysis - DEEP ANALYSIS
    async function fetchEmailDetails(messageIds) {
      const details = [];
      // Fetch more emails for better analysis
      const idsToFetch = messageIds.slice(0, 50);
      
      // Batch fetch for speed
      const fetchPromises = idsToFetch.map(async (id) => {
        try {
          const response = await fetch(
            `https://www.googleapis.com/gmail/v1/users/me/messages/${id}?format=full`,
            { headers: { Authorization: `Bearer ${accessToken}` } }
          );
          const msg = await response.json();
          
          const headers = msg.payload?.headers || [];
          const getHeader = (name) => headers.find(h => h.name.toLowerCase() === name.toLowerCase())?.value || '';
          
          // Extract body text
          let bodyText = '';
          if (msg.payload?.body?.data) {
            bodyText = atob(msg.payload.body.data.replace(/-/g, '+').replace(/_/g, '/'));
          } else if (msg.payload?.parts) {
            const textPart = msg.payload.parts.find(p => p.mimeType === 'text/plain');
            if (textPart?.body?.data) {
              bodyText = atob(textPart.body.data.replace(/-/g, '+').replace(/_/g, '/'));
            }
          }
          
          return {
            id: msg.id,
            threadId: msg.threadId,
            from: getHeader('From'),
            to: getHeader('To'),
            subject: getHeader('Subject'),
            date: getHeader('Date'),
            snippet: msg.snippet,
            bodyPreview: bodyText.slice(0, 500),
            labelIds: msg.labelIds || [],
            internalDate: msg.internalDate,
            // For thread analysis
            references: getHeader('References'),
            inReplyTo: getHeader('In-Reply-To')
          };
        } catch (e) {
          console.error('Error fetching email:', id, e);
          return null;
        }
      });
      
      const results = await Promise.all(fetchPromises);
      return results.filter(r => r !== null);
    }
    
    // Fetch email threads to understand conversation depth
    async function fetchThreadDetails(threadIds) {
      const uniqueThreads = [...new Set(threadIds)].slice(0, 20);
      const threads = [];
      
      for (const threadId of uniqueThreads) {
        try {
          const response = await fetch(
            `https://www.googleapis.com/gmail/v1/users/me/threads/${threadId}?format=metadata`,
            { headers: { Authorization: `Bearer ${accessToken}` } }
          );
          const thread = await response.json();
          threads.push({
            id: thread.id,
            messageCount: thread.messages?.length || 0,
            snippet: thread.snippet,
            subject: thread.messages?.[0]?.payload?.headers?.find(h => h.name === 'Subject')?.value || ''
          });
        } catch (e) {
          console.error('Error fetching thread:', threadId, e);
        }
      }
      
      return threads.sort((a, b) => b.messageCount - a.messageCount);
    }

    // DEEP email analysis - understand the person
    function analyzeEmails(emails) {
      const analysis = {
        // Relationships
        relationships: {},      // email -> { name, count, sentCount, receivedCount, avgResponseTime, lastContact, subjects }
        topRelationships: [],   // sorted by importance
        
        // Content patterns
        topics: {},             // topic -> count
        projects: [],           // detected project names
        importantThreads: [],   // high-engagement threads
        
        // Spending & services
        receipts: [],
        spendingByService: {},
        subscriptions: [],
        
        // Behavioral patterns
        sendingTimes: [],       // hours of day
        avgEmailLength: 0,
        writingStyle: '',       // formal, casual, terse
        responsePatterns: {},
        
        // Work patterns
        workTopics: [],
        personalTopics: [],
        
        totalAnalyzed: emails.length
      };
      
      const receiptSenders = ['doordash', 'uber', 'instacart', 'amazon', 'grubhub', 'postmates', 'caviar', 'seamless', 'apple.com', 'netflix', 'spotify', 'venmo', 'paypal', 'chase', 'amex', 'stripe', 'square', 'shopify'];
      const subscriptionKeywords = ['subscription', 'renewal', 'monthly', 'billing', 'invoice'];
      const workKeywords = ['meeting', 'project', 'deadline', 'deliverable', 'review', 'feedback', 'update', 'sync', 'standup', 'roadmap', 'strategy', 'budget', 'contract', 'proposal', 'client'];
      
      let totalBodyLength = 0;
      let bodyCount = 0;
      
      emails.forEach(email => {
        if (!email.from) return;
        
        // Parse sender
        const fromMatch = email.from.match(/^([^<]+)?<?([^>]+@[^>]+)?>?$/);
        const senderName = (fromMatch?.[1] || fromMatch?.[2] || email.from).trim().replace(/"/g, '').replace(/\s+/g, ' ');
        const senderEmail = (fromMatch?.[2] || email.from).toLowerCase().trim();
        
        // Skip automated/noreply
        if (senderEmail.includes('noreply') || senderEmail.includes('no-reply') || 
            senderEmail.includes('notifications') || senderEmail.includes('mailer-daemon') ||
            senderEmail.includes('postmaster') || senderEmail.includes('calendar-notification')) {
          return;
        }
        
        // Build relationship data
        if (!analysis.relationships[senderEmail]) {
          analysis.relationships[senderEmail] = {
            name: senderName,
            email: senderEmail,
            count: 0,
            subjects: [],
            snippets: [],
            lastContact: null,
            threadIds: new Set()
          };
        }
        
        const rel = analysis.relationships[senderEmail];
        rel.count++;
        if (email.subject && !rel.subjects.includes(email.subject)) {
          rel.subjects.push(email.subject);
        }
        if (email.snippet) {
          rel.snippets.push(email.snippet.slice(0, 100));
        }
        rel.threadIds.add(email.threadId);
        if (email.date) {
          const date = new Date(email.date);
          if (!rel.lastContact || date > rel.lastContact) {
            rel.lastContact = date;
          }
        }
        
        // Analyze sending time
        if (email.internalDate) {
          const hour = new Date(parseInt(email.internalDate)).getHours();
          analysis.sendingTimes.push(hour);
        }
        
        // Analyze body length for writing style
        if (email.bodyPreview) {
          totalBodyLength += email.bodyPreview.length;
          bodyCount++;
        }
        
        // Check for receipts/spending
        if (receiptSenders.some(r => senderEmail.includes(r) || (email.subject || '').toLowerCase().includes(r))) {
          const service = receiptSenders.find(r => senderEmail.includes(r) || (email.subject || '').toLowerCase().includes(r));
          analysis.receipts.push({
            from: senderName,
            subject: email.subject,
            service: service,
            date: email.date
          });
          analysis.spendingByService[service] = (analysis.spendingByService[service] || 0) + 1;
        }
        
        // Check for subscriptions
        if (subscriptionKeywords.some(k => (email.subject || '').toLowerCase().includes(k))) {
          analysis.subscriptions.push({
            from: senderName,
            subject: email.subject
          });
        }
        
        // Extract topics from subject
        const subjectLower = (email.subject || '').toLowerCase();
        workKeywords.forEach(keyword => {
          if (subjectLower.includes(keyword)) {
            analysis.topics[keyword] = (analysis.topics[keyword] || 0) + 1;
          }
        });
      });
      
      // Calculate relationship importance (email count * thread diversity)
      analysis.topRelationships = Object.values(analysis.relationships)
        .map(rel => ({
          ...rel,
          threadCount: rel.threadIds.size,
          importance: rel.count * Math.sqrt(rel.threadIds.size), // weight by conversation diversity
          recentSubject: rel.subjects[rel.subjects.length - 1] || '',
          topSubjects: rel.subjects.slice(-5), // Keep more subjects for insight generation
          recentSnippets: rel.snippets.slice(-3) // Keep recent snippets
        }))
        .filter(rel => rel.count >= 1) // At least 1 email
        .sort((a, b) => b.importance - a.importance)
        .slice(0, 15);
      
      // Detect newsletters/subscriptions more broadly
      const newsletterKeywords = ['newsletter', 'digest', 'weekly', 'daily', 'update', 'news', 'unsubscribe'];
      emails.forEach(email => {
        const subject = (email.subject || '').toLowerCase();
        const snippet = (email.snippet || '').toLowerCase();
        
        if (newsletterKeywords.some(k => subject.includes(k) || snippet.includes('unsubscribe'))) {
          const fromMatch = email.from?.match(/^([^<]+)?<?([^>]+@[^>]+)?>?$/);
          const senderName = (fromMatch?.[1] || fromMatch?.[2] || email.from || '').trim().replace(/"/g, '');
          if (senderName && !analysis.subscriptions.find(s => s.from === senderName)) {
            analysis.subscriptions.push({
              from: senderName,
              subject: email.subject
            });
          }
        }
      });
      
      // Find most engaged threads (multiple back-and-forth)
      const threadCounts = {};
      emails.forEach(e => {
        if (e.threadId) {
          if (!threadCounts[e.threadId]) {
            threadCounts[e.threadId] = { count: 0, subject: e.subject, snippet: e.snippet, participants: new Set() };
          }
          threadCounts[e.threadId].count++;
          if (e.from) threadCounts[e.threadId].participants.add(e.from);
        }
      });
      
      analysis.importantThreads = Object.entries(threadCounts)
        .filter(([_, t]) => t.count >= 2) // At least 2 messages in thread
        .sort((a, b) => b[1].count - a[1].count)
        .slice(0, 10)
        .map(([id, t]) => ({
          threadId: id,
          messageCount: t.count,
          subject: t.subject,
          snippet: t.snippet,
          participantCount: t.participants.size
        }));
      
      // Calculate avg email length and style
      analysis.avgEmailLength = bodyCount > 0 ? Math.round(totalBodyLength / bodyCount) : 0;
      if (analysis.avgEmailLength < 100) {
        analysis.writingStyle = 'terse and direct';
      } else if (analysis.avgEmailLength < 300) {
        analysis.writingStyle = 'concise but thorough';
      } else {
        analysis.writingStyle = 'detailed and comprehensive';
      }
      
      // Analyze time patterns
      const hourCounts = {};
      analysis.sendingTimes.forEach(h => { hourCounts[h] = (hourCounts[h] || 0) + 1; });
      const peakHour = Object.entries(hourCounts).sort((a, b) => b[1] - a[1])[0]?.[0];
      analysis.peakActivityHour = peakHour ? parseInt(peakHour) : null;
      analysis.isEarlyBird = analysis.sendingTimes.filter(h => h >= 5 && h < 9).length > analysis.sendingTimes.length * 0.3;
      analysis.isNightOwl = analysis.sendingTimes.filter(h => h >= 21 || h < 5).length > analysis.sendingTimes.length * 0.2;
      
      // Sort topics by frequency
      analysis.workTopics = Object.entries(analysis.topics)
        .sort((a, b) => b[1] - a[1])
        .slice(0, 5)
        .map(([topic, count]) => ({ topic, count }));
      
      return analysis;
    }

    // SMART calendar analysis - understand how they spend their time
    function analyzeCalendar(events) {
      const analysis = {
        total: events.length,
        
        // Event categories
        workMeetings: [],       // meetings with others about work
        oneOnOnes: [],          // 1:1 meetings
        personalBlocks: [],     // solo time blocks (focus, etc)
        healthEvents: [],       // gym, PT, doctor, etc
        socialEvents: [],       // lunch, coffee, etc
        recurringRituals: [],   // daily/weekly recurring personal blocks
        
        // Relationship data
        attendeeCounts: {},
        topCollaborators: [],
        
        // Patterns
        avgMeetingsPerDay: 0,
        busiestDay: null,
        protectedTime: [],      // recurring focus/personal blocks
        
        // Upcoming important
        upcomingWorkMeetings: [],
        upcomingPersonal: []
      };
      
      // Keywords for categorization
      const healthKeywords = ['pt', 'physical therapy', 'gym', 'workout', 'doctor', 'dentist', 'therapy', 'meditation', 'yoga', 'run', 'exercise', 'health'];
      const socialKeywords = ['lunch', 'coffee', 'dinner', 'drinks', 'happy hour', 'catch up', 'hangout'];
      const focusKeywords = ['focus', 'deep work', 'heads down', 'blocked', 'personal', 'me time', 'admin'];
      const ritualKeywords = ['morning', 'routine', 'standup', 'daily', 'weekly review', 'planning', 'journal', 'eat', 'meal'];
      
      const dayEventCounts = {};
      
      events.forEach(event => {
        const title = (event.summary || '').toLowerCase();
        const attendees = event.attendees || [];
        const otherAttendees = attendees.filter(a => !a.self);
        const startDate = new Date(event.start?.dateTime || event.start?.date);
        const dayKey = startDate.toLocaleDateString('en-US', { weekday: 'long' });
        
        dayEventCounts[dayKey] = (dayEventCounts[dayKey] || 0) + 1;
        
        const eventInfo = {
          title: event.summary,
          start: event.start?.dateTime || event.start?.date,
          attendees: otherAttendees.map(a => a.displayName || a.email?.split('@')[0] || 'Unknown'),
          attendeeEmails: otherAttendees.map(a => a.email).filter(Boolean),
          isRecurring: !!event.recurringEventId,
          dayOfWeek: dayKey
        };
        
        // Categorize the event
        if (healthKeywords.some(k => title.includes(k))) {
          analysis.healthEvents.push(eventInfo);
          analysis.upcomingPersonal.push({ ...eventInfo, category: 'health' });
        } else if (socialKeywords.some(k => title.includes(k))) {
          analysis.socialEvents.push(eventInfo);
          analysis.upcomingPersonal.push({ ...eventInfo, category: 'social' });
        } else if (otherAttendees.length === 0) {
          // No other attendees - personal block
          if (focusKeywords.some(k => title.includes(k))) {
            analysis.personalBlocks.push(eventInfo);
          } else if (ritualKeywords.some(k => title.includes(k))) {
            analysis.recurringRituals.push(eventInfo);
          } else {
            analysis.personalBlocks.push(eventInfo);
          }
          analysis.upcomingPersonal.push({ ...eventInfo, category: 'personal' });
        } else if (otherAttendees.length === 1) {
          // 1:1 meeting
          analysis.oneOnOnes.push(eventInfo);
          analysis.upcomingWorkMeetings.push({ ...eventInfo, category: '1:1' });
          
          // Track collaborator
          const collaborator = eventInfo.attendees[0];
          analysis.attendeeCounts[collaborator] = (analysis.attendeeCounts[collaborator] || 0) + 1;
        } else {
          // Group meeting
          analysis.workMeetings.push(eventInfo);
          analysis.upcomingWorkMeetings.push({ ...eventInfo, category: 'group' });
          
          // Track collaborators
          eventInfo.attendees.forEach(name => {
            analysis.attendeeCounts[name] = (analysis.attendeeCounts[name] || 0) + 1;
          });
        }
      });
      
      // Calculate top collaborators
      analysis.topCollaborators = Object.entries(analysis.attendeeCounts)
        .sort((a, b) => b[1] - a[1])
        .slice(0, 10)
        .map(([name, count]) => ({ name, meetingCount: count }));
      
      // Find busiest day
      const busiestEntry = Object.entries(dayEventCounts).sort((a, b) => b[1] - a[1])[0];
      analysis.busiestDay = busiestEntry ? { day: busiestEntry[0], count: busiestEntry[1] } : null;
      
      // Calculate meeting patterns
      const totalMeetingsWithOthers = analysis.workMeetings.length + analysis.oneOnOnes.length;
      const totalSoloBlocks = analysis.personalBlocks.length + analysis.healthEvents.length + analysis.recurringRituals.length;
      analysis.meetingPercentage = events.length > 0 ? Math.round((totalMeetingsWithOthers / events.length) * 100) : 0;
      analysis.soloPercentage = events.length > 0 ? Math.round((totalSoloBlocks / events.length) * 100) : 0;
      
      // Sort upcoming by date
      analysis.upcomingWorkMeetings.sort((a, b) => new Date(a.start) - new Date(b.start));
      analysis.upcomingPersonal.sort((a, b) => new Date(a.start) - new Date(b.start));
      
      // Identify if they're a meeting person or independent worker
      if (analysis.soloPercentage > 70) {
        analysis.workStyle = 'independent';
        analysis.workStyleInsight = "You fiercely protect your solo time. Most of your calendar is intentional blocks for focus, health, and personal rituals.";
      } else if (analysis.meetingPercentage > 50) {
        analysis.workStyle = 'collaborative';
        analysis.workStyleInsight = "You're deeply collaborative. Most of your time is spent with others, building relationships and driving projects forward.";
      } else {
        analysis.workStyle = 'balanced';
        analysis.workStyleInsight = "You balance solo deep work with collaborative time. You know when to focus and when to connect.";
      }
      
      return analysis;
    }

    // ============================================
    // BROWSER PERMISSIONS
    // ============================================
    async function requestLocation() {
      // Always request real location permission
      const card = document.getElementById('perm-location');
      const btn = card.querySelector('.permission-btn');
      card.classList.add('connecting');
      btn.classList.add('connecting');
      btn.textContent = 'Requesting...';

      try {
        const position = await new Promise((resolve, reject) => {
          navigator.geolocation.getCurrentPosition(resolve, reject);
        });
        
        userData.location = {
          lat: position.coords.latitude,
          lng: position.coords.longitude
        };

        // Reverse geocode to get city
        try {
          const response = await fetch(
            `https://nominatim.openstreetmap.org/reverse?lat=${position.coords.latitude}&lon=${position.coords.longitude}&format=json`
          );
          const data = await response.json();
          userData.location.city = data.address?.city || data.address?.town || data.address?.county || 'Unknown';
          userData.location.country = data.address?.country || '';
        } catch (e) {
          userData.location.city = 'Location obtained';
        }

        card.classList.remove('connecting');
        card.classList.add('connected');
        btn.classList.remove('connecting');
        btn.classList.add('connected');
        btn.textContent = userData.location.city;
        
        permissionsGranted.location = true;
        updatePermissionProgress();

      } catch (error) {
        card.classList.remove('connecting');
        card.classList.add('denied');
        btn.classList.remove('connecting');
        btn.textContent = 'Denied';
      }
    }

    async function requestMicrophone() {
      // Always request real microphone permission
      const card = document.getElementById('perm-mic');
      const btn = card.querySelector('.permission-btn');
      card.classList.add('connecting');
      btn.classList.add('connecting');
      btn.textContent = 'Requesting...';

      try {
        const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
        stream.getTracks().forEach(track => track.stop()); // Stop immediately

        card.classList.remove('connecting');
        card.classList.add('connected');
        btn.classList.remove('connecting');
        btn.classList.add('connected');
        btn.textContent = 'Connected';
        
        permissionsGranted.mic = true;
        updatePermissionProgress();

      } catch (error) {
        card.classList.remove('connecting');
        card.classList.add('denied');
        btn.classList.remove('connecting');
        btn.textContent = 'Denied';
      }
    }

    async function requestNotifications() {
      // Always request real notification permission
      const card = document.getElementById('perm-notifications');
      const btn = card.querySelector('.permission-btn');
      card.classList.add('connecting');
      btn.classList.add('connecting');
      btn.textContent = 'Requesting...';

      try {
        const permission = await Notification.requestPermission();
        
        if (permission === 'granted') {
          card.classList.remove('connecting');
          card.classList.add('connected');
          btn.classList.remove('connecting');
          btn.classList.add('connected');
          btn.textContent = 'Connected';
          
          permissionsGranted.notifications = true;
          updatePermissionProgress();
        } else {
          throw new Error('Denied');
        }

      } catch (error) {
        card.classList.remove('connecting');
        card.classList.add('denied');
        btn.classList.remove('connecting');
        btn.textContent = 'Denied';
      }
    }

    function simulateConnection(type) {
      const card = document.getElementById('perm-' + type);
      const btn = card.querySelector('.permission-btn');
      card.classList.add('connecting');
      btn.classList.add('connecting');
      btn.textContent = 'Connecting...';

      setTimeout(() => {
        card.classList.remove('connecting');
        card.classList.add('connected');
        btn.classList.remove('connecting');
        btn.classList.add('connected');
        btn.textContent = 'Connected';
        
        permissionsGranted[type] = true;
        updatePermissionProgress();
      }, 800);
    }

    function updatePermissionProgress() {
      const count = Object.values(permissionsGranted).filter(v => v).length;
      document.getElementById('connectedCount').textContent = count;
      
      // Enable continue when Google is connected
      if (permissionsGranted.google) {
        document.getElementById('continueBtn').classList.add('enabled');
      }
    }

    // ============================================
    // LOADING OVERLAY
    // ============================================
    function showLoading(text) {
      document.getElementById('loadingText').textContent = text;
      document.getElementById('loadingOverlay').classList.add('active');
    }

    function hideLoading() {
      document.getElementById('loadingOverlay').classList.remove('active');
    }

    // ============================================
    // PARTICLES
    // ============================================
    function createParticles() {
      const container = document.getElementById('particles');
      for (let i = 0; i < 60; i++) {
        const p = document.createElement('div');
        p.className = 'particle';
        p.style.left = Math.random() * 100 + '%';
        p.style.top = Math.random() * 100 + '%';
        const duration = 6 + Math.random() * 6;
        const delay = Math.random() * duration;
        p.style.animation = `particleFloat ${duration}s ease-in-out ${delay}s infinite`;
        container.appendChild(p);
      }

      const style = document.createElement('style');
      style.textContent = `
        @keyframes particleFloat {
          0%, 100% { opacity: 0; transform: translate(0, 0); }
          15% { opacity: 0.5; }
          85% { opacity: 0.5; }
          50% { transform: translate(${Math.random() > 0.5 ? '' : '-'}${15 + Math.random() * 25}px, -${20 + Math.random() * 40}px); }
        }
      `;
      document.head.appendChild(style);
    }
    createParticles();

    // ============================================
    // ONBOARDING FLOW
    // ============================================
    function begin() {
      document.getElementById('seq0').classList.remove('active');
      
      // Start music if not already playing, then fade in
      if (music.paused) {
        music.volume = 0.05;
        music.play().then(() => fadeInMusic()).catch(() => {});
      } else {
        fadeInMusic();
      }
      
      setTimeout(() => {
        document.getElementById('scanBeam').classList.add('active');
      }, 300);

      setTimeout(() => runSequence1(), 800);
    }

    function runSequence1() {
      document.getElementById('seq1').classList.add('active');
      
      const lines = [
        { text: '> Establishing secure connection...', delay: 150 },
        { text: '> Initializing end-to-end encryption...', delay: 200 },
        { text: '> AES-256-GCM cipher established', delay: 150, success: true },
        { text: '> Verifying local-first architecture...', delay: 200 },
        { text: '> No cloud storage detected', delay: 100, success: true, check: true },
        { text: '> Your data never leaves this device', delay: 100, success: true, check: true },
        { text: '> ', delay: 600 },
        { text: '> Encryption achieved.', delay: 200, success: true },
        { text: '> Awaiting identity confirmation...', delay: 300, cursor: true }
      ];

      const container = document.getElementById('initText');
      let lineIdx = 0;

      function showLine() {
        if (lineIdx < lines.length) {
          const line = lines[lineIdx];
          const div = document.createElement('div');
          div.className = 'init-line' + (line.success ? ' success' : '');
          div.innerHTML = line.text + (line.check ? '<span class="checkmark">✓</span>' : '') + (line.cursor ? '<span class="init-cursor"></span>' : '');
          container.appendChild(div);
          
          setTimeout(() => div.classList.add('show'), 50);
          lineIdx++;
          
          setTimeout(showLine, line.delay + Math.random() * 100);
        } else {
          setTimeout(() => {
            document.getElementById('seq1').classList.remove('active');
            runSequence2();
          }, 1500);
        }
      }

      setTimeout(showLine, 400);
    }

    function runSequence2() {
      document.getElementById('seq2').classList.add('active');
      setTimeout(() => {
        document.getElementById('permissionsContainer').classList.add('show');
      }, 200);
    }

    function finishPermissions() {
      document.getElementById('seq2').classList.remove('active');
      runSequence3();
    }

    async function runSequence3() {
      document.getElementById('seq3').classList.add('active');
      
      setTimeout(() => {
        document.getElementById('analyzingHeader').classList.add('show');
      }, 200);

      // Build dynamic analysis messages based on REAL data
      const cal = userData.calendar.analysis || {};
      const email = userData.email.analysis || {};
      const eventCount = userData.calendar.events?.length || 0;
      const emailCount = userData.email.details?.length || 0;
      const relationshipCount = email.topRelationships?.length || 0;
      const receiptCount = email.receipts?.length || 0;
      const topRelationship = email.topRelationships?.[0];
      const topCollaborator = cal.topCollaborators?.[0];
      
      const analyses = [
        { 
          text: 'Reading your calendar...', 
          result: eventCount > 0 
            ? `${eventCount} events — ${cal.workMeetings?.length || 0} meetings, ${cal.personalBlocks?.length || 0} personal blocks`
            : 'no events found'
        },
        { 
          text: 'Analyzing your inbox...', 
          result: emailCount > 0 
            ? `${emailCount} emails scanned`
            : 'inbox accessed'
        },
        { 
          text: 'Mapping your relationships...', 
          result: topRelationship
            ? `${topRelationship.name} — ${topRelationship.count} emails`
            : 'building relationship graph'
        },
        { 
          text: 'Finding conversation patterns...', 
          result: email.importantThreads?.length > 0
            ? `${email.importantThreads.length} active threads detected`
            : 'analyzing threads'
        },
        { 
          text: 'Learning your style...', 
          result: email.writingStyle 
            ? `${email.writingStyle}`
            : 'profile building'
        },
        { 
          text: 'Understanding your priorities...', 
          result: cal.workStyle
            ? `${cal.workStyle} work style identified`
            : 'patterns emerging'
        }
      ];

      const container = document.getElementById('analyzeLines');
      container.innerHTML = ''; // Clear
      const progressBar = document.getElementById('analyzeProgressBar');
      let idx = 0;

      setTimeout(() => {
        document.getElementById('analyzeProgress').classList.add('show');
      }, 600);

      function showAnalysis() {
        if (idx < analyses.length) {
          const analysis = analyses[idx];
          const div = document.createElement('div');
          div.className = 'analyze-line';
          div.innerHTML = `<span class="spinner"></span><span>${analysis.text}</span>`;
          container.appendChild(div);
          
          setTimeout(() => div.classList.add('show'), 50);
          
          setTimeout(() => {
            div.classList.add('complete');
            div.innerHTML = `<span>${analysis.text} ${analysis.result}</span>`;
            progressBar.style.width = ((idx + 1) / analyses.length * 100) + '%';
            
            idx++;
            setTimeout(showAnalysis, 600);
          }, 800);
        } else {
          setTimeout(() => {
            document.getElementById('seq3').classList.remove('active');
            runSequence4();
          }, 1200);
        }
      }

      setTimeout(showAnalysis, 800);
    }

    async function generateBehavioralInsights() {
      // Generate insights using Claude based on real data
      const calendarSummary = userData.calendar.events.slice(0, 10).map(e => 
        `${e.summary} on ${new Date(e.start?.dateTime || e.start?.date).toLocaleDateString()}`
      ).join(', ');

      const prompt = `Based on this user data, generate 6 "I know you" insights that are slightly unnerving but impressive. Format each as HTML with <span class='data'>specific data</span> for numbers/times and <span class='highlight'>name</span> for names.

User: ${userData.name}
Email: ${userData.email}
Location: ${userData.location?.city || 'Unknown'}
Calendar events this month: ${userData.calendar.events.length}
Upcoming: ${calendarSummary}
Unread emails: ${userData.email.unreadCount}

Generate insights about work patterns, communication style, scheduling habits. Be specific with made-up but realistic numbers. Example:
"I know you start work at <span class='data'>8:47am</span> — but Mondays you're up at <span class='data'>6:12am</span>."

Return ONLY a JSON array of 6 insight strings, nothing else.`;

      try {
        const response = await fetch('https://api.anthropic.com/v1/messages', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'x-api-key': CONFIG.ANTHROPIC_API_KEY,
            'anthropic-version': '2023-06-01',
            'anthropic-dangerous-direct-browser-access': 'true'
          },
          body: JSON.stringify({
            model: 'claude-3-haiku-20240307',
            max_tokens: 1024,
            messages: [{ role: 'user', content: prompt }]
          })
        });

        const data = await response.json();
        const content = data.content?.[0]?.text || '';
        
        // Try to parse JSON from response
        const jsonMatch = content.match(/\[[\s\S]*\]/);
        if (jsonMatch) {
          userData.insights = JSON.parse(jsonMatch[0]);
        }
      } catch (error) {
        console.error('Error generating insights:', error);
        // Fall back to template insights
        generateTemplateInsights();
      }
    }

    function generateTemplateInsights() {
      const name = userData.name || 'Friend';
      const location = userData.location?.city || null;
      const cal = userData.calendar.analysis || {};
      const email = userData.email.analysis || {};
      const unread = userData.email.unreadCount || 0;
      
      const insights = [];
      
      // Opening
      insights.push("I've been watching. <em>Learning.</em>");
      
      // Location + time context
      if (location) {
        const hour = new Date().getHours();
        let timeContext = '';
        if (hour < 9) timeContext = "Early start.";
        else if (hour < 12) timeContext = "Morning grind.";
        else if (hour < 17) timeContext = "Middle of your day.";
        else if (hour < 21) timeContext = "Winding down, or pushing through?";
        else timeContext = "You work late.";
        
        insights.push(`I see you're in <span class='data'>${location}</span>. ${timeContext}`);
      }
      
      // CALENDAR WORK STYLE - smarter insight
      if (cal.workStyle === 'independent') {
        insights.push(`You fiercely protect your solo time. Most of your calendar is intentional blocks for focus, health, and personal rituals.`);
      } else if (cal.workStyle === 'collaborative') {
        insights.push(`Your calendar is packed with people. Back-to-back meetings — you're in high demand.`);
      } else if (cal.workStyleInsight) {
        insights.push(cal.workStyleInsight);
      }
      
      // HEALTH RITUALS - with frequency analysis
      if (cal.healthEvents?.length > 0) {
        // Group by title to find frequency
        const healthByTitle = {};
        cal.healthEvents.forEach(e => {
          const title = e.title?.toLowerCase() || 'health';
          healthByTitle[title] = (healthByTitle[title] || 0) + 1;
        });
        
        const healthEntries = Object.entries(healthByTitle).sort((a, b) => b[1] - a[1]);
        if (healthEntries.length > 0) {
          const [topHealth, count] = healthEntries[0];
          const displayName = topHealth.charAt(0).toUpperCase() + topHealth.slice(1);
          
          if (count >= 3) {
            insights.push(`I see you prioritize your health — <span class='highlight'>${displayName}</span> ${count >= 4 ? 'multiple times a week' : 'regularly'}. That's discipline.`);
          } else if (count === 2) {
            insights.push(`<span class='highlight'>${displayName}</span> twice on your calendar. You're consistent with your health.`);
          } else {
            insights.push(`I see <span class='highlight'>${displayName}</span> on your calendar. You make time for health.`);
          }
        }
      }
      
      // ACTUAL EMAIL CONTENT - the juicy stuff
      const topRel = email.topRelationships?.[0];
      if (topRel && topRel.snippets?.length > 0) {
        // Get a real snippet from their conversation
        const snippet = topRel.snippets[0];
        const recentSubject = topRel.topSubjects?.[0];
        
        if (recentSubject && snippet) {
          insights.push(`Your conversation with <span class='highlight'>${topRel.name}</span>: "<span class='data'>${recentSubject.slice(0, 40)}${recentSubject.length > 40 ? '...' : ''}</span>" — I can see the back-and-forth.`);
        } else if (topRel.count >= 5) {
          insights.push(`<span class='highlight'>${topRel.name}</span> — <span class='data'>${topRel.count}</span> emails, <span class='data'>${topRel.threadCount}</span> threads. You two talk a lot.`);
        }
      }
      
      // INTENSE CONVERSATIONS - multi-message threads
      if (email.importantThreads?.length > 0) {
        const hotThread = email.importantThreads.find(t => t.messageCount >= 4);
        if (hotThread && hotThread.subject) {
          insights.push(`"<span class='highlight'>${hotThread.subject.slice(0, 45)}${hotThread.subject.length > 45 ? '...' : ''}</span>" — <span class='data'>${hotThread.messageCount}</span> messages deep. That conversation is heating up.`);
        }
      }
      
      // SUBSCRIPTIONS & NEWSLETTERS
      if (email.subscriptions?.length > 0) {
        const subNames = [...new Set(email.subscriptions.map(s => s.from.split(' ')[0]))].slice(0, 3);
        if (subNames.length > 0) {
          insights.push(`You're subscribed to <span class='highlight'>${subNames.join(', ')}</span>. I see what you're reading.`);
        }
      }
      
      // SPENDING - be specific
      const spendingServices = Object.entries(email.spendingByService || {}).sort((a, b) => b[1] - a[1]);
      if (spendingServices.length >= 2) {
        const services = spendingServices.slice(0, 3).map(([s, c]) => {
          const name = s.charAt(0).toUpperCase() + s.slice(1);
          return `<span class='highlight'>${name}</span> (${c})`;
        });
        insights.push(`Your receipts: ${services.join(', ')}. I know where your money goes.`);
      }
      
      // REAL EMAIL SUBJECT EXAMPLES
      const recentEmails = email.topRelationships?.slice(0, 3).filter(r => r.topSubjects?.length > 0);
      if (recentEmails?.length > 0) {
        const emailExamples = recentEmails.map(r => `"${r.topSubjects[0]?.slice(0, 30) || ''}..."`).filter(s => s.length > 10);
        if (emailExamples.length > 0) {
          insights.push(`Recent in your inbox: ${emailExamples.slice(0, 2).join(', ')}. I'm reading everything.`);
        }
      }
      
      // CALENDAR PERSON vs EMAIL PERSON cross-reference
      const topCalPerson = cal.topCollaborators?.[0];
      if (topCalPerson && topRel) {
        const calName = topCalPerson.name.toLowerCase();
        const emailName = topRel.name.toLowerCase();
        
        if (calName !== emailName && !calName.includes(emailName.split(' ')[0]) && !emailName.includes(calName.split(' ')[0])) {
          // Different people - interesting insight
          insights.push(`<span class='highlight'>${topCalPerson.name}</span> gets your time (${topCalPerson.meetingCount} meetings). <span class='highlight'>${topRel.name}</span> gets your words (${topRel.count} emails). Different relationships.`);
        }
      }
      
      // TIME PATTERNS - fix the undefined bug
      if (email.isEarlyBird) {
        insights.push(`You're an early bird — emails going out before most people wake up.`);
      } else if (email.isNightOwl) {
        insights.push(`Night owl — some of your best work happens after hours.`);
      } else if (email.peakActivityHour !== null && email.peakActivityHour !== undefined) {
        const hour = parseInt(email.peakActivityHour);
        if (!isNaN(hour)) {
          const displayHour = hour === 0 ? '12am' : hour === 12 ? '12pm' : hour > 12 ? `${hour - 12}pm` : `${hour}am`;
          insights.push(`Peak activity around <span class='data'>${displayHour}</span>. That's when you're most engaged.`);
        }
      }
      
      // UNREAD
      if (unread > 100) {
        insights.push(`<span class='data'>${unread}</span> unread. You're drowning. Let me help.`);
      } else if (unread > 30) {
        insights.push(`<span class='data'>${unread}</span> unread and building. I can prioritize.`);
      }
      
      // POWERFUL CLOSING
      insights.push("I know who matters to you. I know how you work. I know what you're building.");
      insights.push("And I'm just getting started.");
      
      userData.insights = insights;
    }

    function runSequence4() {
      document.getElementById('seq4').classList.add('active');

      // Generate insights from real data
      generateTemplateInsights();

      // Build lines from insights (insights already include intro)
      const lines = userData.insights.map((text, i) => {
        // First line is intro
        if (i === 0) return { text, type: 'intro' };
        // Last two lines are finale
        if (i >= userData.insights.length - 2) return { text, type: 'finale' };
        // Middle lines are insights
        return { text, type: 'insight' };
      });

      const container = document.getElementById('skippySpeaks');
      container.innerHTML = ''; // Clear any existing content
      let lineIdx = 0;

      function showLine() {
        if (lineIdx < lines.length) {
          const line = lines[lineIdx];
          const div = document.createElement('div');
          div.className = 'skippy-line' + (line.type === 'finale' ? ' finale' : '');
          div.innerHTML = line.text;
          container.appendChild(div);
          
          setTimeout(() => div.classList.add('show'), 100);
          lineIdx++;
          
          const delay = line.type === 'finale' ? 2200 : 2500;
          setTimeout(showLine, delay);
        } else {
          setTimeout(() => {
            document.getElementById('seq4').classList.remove('active');
            runSequence5();
          }, 2500);
        }
      }

      setTimeout(showLine, 600);
    }

    function runSequence5() {
      document.getElementById('seq5').classList.add('active');
      
      // Show header first
      setTimeout(() => {
        document.getElementById('capabilitiesHeader').classList.add('show');
      }, 200);
      
      // Generate capability statements from real data
      const capabilities = generateDemos();
      
      const container = document.getElementById('capabilityLines');
      container.innerHTML = '';
      
      let idx = 0;
      
      function showCapability() {
        if (idx < capabilities.length) {
          const line = capabilities[idx];
          const div = document.createElement('div');
          div.className = 'skippy-line';
          div.innerHTML = line;
          container.appendChild(div);
          
          setTimeout(() => div.classList.add('show'), 50);
          
          idx++;
          setTimeout(showCapability, 1000); // Show next capability
        } else {
          // All capabilities shown, move to next sequence
          setTimeout(() => {
            document.getElementById('seq5').classList.remove('active');
            runSequence6();
          }, 2500);
        }
      }
      
      setTimeout(showCapability, 800);
    }

    function generateDemos() {
      // Generate flowing capability statements - NOT interactive cards
      const capabilities = [];
      const cal = userData.calendar.analysis || {};
      const email = userData.email.analysis || {};
      
      // CALENDAR-BASED CAPABILITIES
      const nextWorkMeeting = cal.upcomingWorkMeetings?.[0];
      if (nextWorkMeeting && nextWorkMeeting.attendees?.length > 0) {
        const attendee = nextWorkMeeting.attendees[0];
        const eventDate = new Date(nextWorkMeeting.start);
        const dayName = eventDate.toLocaleDateString('en-US', { weekday: 'long' });
        
        // Cross-reference with email
        const emailRel = email.topRelationships?.find(r => 
          r.name.toLowerCase().includes(attendee.toLowerCase()) || 
          attendee.toLowerCase().includes(r.name.toLowerCase().split(' ')[0])
        );
        
        if (emailRel) {
          capabilities.push(`<span class="highlight">${nextWorkMeeting.title}</span> with ${attendee} on ${dayName}. I found <span class="data">${emailRel.count}</span> emails between you — I'll prep the context.`);
        } else {
          capabilities.push(`<span class="highlight">${nextWorkMeeting.title}</span> on ${dayName}. I'll pull together a brief before you walk in.`);
        }
      }
      
      // PERSONAL/HEALTH events - don't offer prep, offer protection
      if (cal.healthEvents?.length > 0) {
        const healthEvent = cal.healthEvents[0];
        capabilities.push(`<span class="highlight">${healthEvent.title}</span> is protected. I'll never schedule over your health.`);
      }
      
      // HOME/PERSONAL events - contextual help
      const personalEvent = cal.upcomingPersonal?.find(e => 
        e.title?.toLowerCase().includes('clean') || 
        e.title?.toLowerCase().includes('stacie') ||
        e.title?.toLowerCase().includes('home')
      );
      if (personalEvent) {
        capabilities.push(`<span class="highlight">${personalEvent.title}</span> on your calendar. I can remind you to leave cash or send a confirmation text.`);
      }
      
      // EMAIL-BASED CAPABILITIES
      const topRel = email.topRelationships?.[0];
      if (topRel && topRel.topSubjects?.length > 0) {
        const subject = topRel.topSubjects[0];
        capabilities.push(`Your thread with <span class="highlight">${topRel.name}</span>: "<span class="data">${subject?.slice(0, 35) || ''}...</span>" — I can draft your reply.`);
      }
      
      // HOT CONVERSATION
      const hotThread = email.importantThreads?.find(t => t.messageCount >= 3);
      if (hotThread && hotThread.subject) {
        capabilities.push(`"<span class="highlight">${hotThread.subject.slice(0, 40)}${hotThread.subject.length > 40 ? '...' : ''}</span>" is <span class="data">${hotThread.messageCount}</span> messages deep. I'll summarize it and extract action items.`);
      }
      
      // SPENDING
      const spendingServices = Object.entries(email.spendingByService || {}).sort((a, b) => b[1] - a[1]);
      if (spendingServices.length >= 2) {
        const topService = spendingServices[0][0].charAt(0).toUpperCase() + spendingServices[0][0].slice(1);
        capabilities.push(`<span class="data">${spendingServices.reduce((s, [_, c]) => s + c, 0)}</span> receipts tracked. <span class="highlight">${topService}</span> is your biggest spend. I'll categorize everything.`);
      }
      
      // WRITING STYLE
      if (email.writingStyle && email.totalAnalyzed > 10) {
        capabilities.push(`I've learned your writing style from <span class="data">${email.totalAnalyzed}</span> emails. When I write for you, it sounds like you.`);
      }
      
      // WORK STYLE
      if (cal.workStyle === 'independent' && cal.soloPercentage) {
        capabilities.push(`<span class="data">${cal.soloPercentage}%</span> of your time is protected focus. I'll defend it.`);
      } else if (cal.workStyle === 'collaborative' && cal.meetingPercentage) {
        capabilities.push(`<span class="data">${cal.meetingPercentage}%</span> of your time is meetings. I'll find you breathing room.`);
      }
      
      // LOCATION
      if (userData.location?.city) {
        capabilities.push(`You're in <span class="highlight">${userData.location.city}</span>. I factor in commute, time zones, and local context — always.`);
      }
      
      // Fallback
      if (capabilities.length === 0) {
        capabilities.push(`Every email, meeting, and pattern I see makes me smarter about how to help you.`);
      }
      
      return capabilities.slice(0, 8);
    }


    function runSequence6() {
      document.getElementById('seq6').classList.add('active');
      
      const promiseText = document.getElementById('promiseText');
      const promiseSub = document.getElementById('promiseSub');
      
      promiseText.textContent = "I'm not an assistant. I'm an extension of you.";
      
      setTimeout(() => promiseText.classList.add('show'), 400);
      
      setTimeout(() => {
        promiseSub.textContent = "I think like you. I anticipate like you. I act like you would — if you had infinite time and attention.";
        promiseSub.classList.add('show');
      }, 2200);

      setTimeout(() => {
        document.getElementById('seq6').classList.remove('active');
        runSequence7();
      }, 6000);
    }

    function runSequence7() {
      document.getElementById('seq7').classList.add('active');
      
      const name = userData.name || 'friend';
      document.getElementById('welcomeGreeting').textContent = `Welcome home, ${name}.`;
      
      // Update tagline to be more personal
      const emailAnalysis = userData.email.analysis || {};
      const topSender = emailAnalysis.topSenders?.[0]?.[0];
      if (topSender) {
        document.getElementById('welcomeTagline').textContent = `I know your inbox. I know ${topSender}. I know you.`;
      }
      
      setTimeout(() => document.getElementById('welcomeLogo').classList.add('show'), 200);
      setTimeout(() => document.getElementById('welcomeTagline').classList.add('show'), 200);
      setTimeout(() => document.getElementById('welcomeGreeting').classList.add('show'), 200);
      setTimeout(() => document.getElementById('beginBtn').classList.add('show'), 200);
      setTimeout(() => document.getElementById('shortcutDisplay').classList.add('show'), 1800);
    }

    function finish() {
      // Fade out music
      fadeOutMusic();
      
      document.body.style.transition = 'opacity 1s ease';
      document.body.style.opacity = '0';
      
      setTimeout(() => {
        alert(`Welcome to Skippy, ${userData.name || 'friend'}.\n\nPress ⌥ + Space anytime to summon me.`);
      }, 1000);
    }

    // ============================================
    // MUSIC
    // ============================================
    const music = document.getElementById('music');
    
    function startBackgroundMusic() {
      music.volume = 0.05;
      music.play().catch(() => {}); // Ignore autoplay restrictions
    }

    function fadeInMusic() {
      let vol = music.volume;
      const fadeIn = setInterval(() => {
        vol += 0.015;
        if (vol >= 0.25) {
          clearInterval(fadeIn);
          music.volume = 0.25;
        } else {
          music.volume = vol;
        }
      }, 100);
    }

    function fadeOutMusic() {
      let vol = music.volume;
      const fadeOut = setInterval(() => {
        vol -= 0.02;
        if (vol <= 0) {
          clearInterval(fadeOut);
          music.pause();
        } else {
          music.volume = vol;
        }
      }, 50);
    }

    // ============================================
    // INIT
    // ============================================
    
    // Wait for Google API to load
    function waitForGoogle(callback, maxAttempts = 20) {
      let attempts = 0;
      const check = () => {
        attempts++;
        if (window.google?.accounts?.oauth2) {
          console.log('Google Identity Services loaded');
          callback();
        } else if (attempts < maxAttempts) {
          console.log('Waiting for Google API... attempt', attempts);
          setTimeout(check, 250);
        } else {
          console.error('Google API failed to load after', maxAttempts, 'attempts');
        }
      };
      check();
    }

    waitForGoogle(() => {
      checkSetup();
    });
    
    // Start music when page loads (low volume)
    startBackgroundMusic();
  </script>
</body>
</html>
