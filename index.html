<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Skippy — Onboarding</title>
  <link href="https://fonts.googleapis.com/css2?family=Crimson+Pro:ital,wght@0,300;0,400;1,300;1,400&family=Inter:wght@300;400;500;600&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
  
  <!-- Google API Client -->
  <script src="https://apis.google.com/js/api.js"></script>
  <script src="https://accounts.google.com/gsi/client"></script>
  
  <style>
    :root {
      --void: #030305;
      --deep: #08080c;
      --gold: #c4a35a;
      --gold-bright: #d4b86a;
      --gold-glow: rgba(196, 163, 90, 0.4);
      --gold-dim: rgba(196, 163, 90, 0.15);
      --sage: #7a8c6a;
      --sage-dark: #5a6c4a;
      --cream: #f0ebe0;
      --text: #ffffff;
      --text-dim: rgba(255, 255, 255, 0.5);
      --text-faint: rgba(255, 255, 255, 0.25);
    }

    * { margin: 0; padding: 0; box-sizing: border-box; }

    html, body {
      width: 100%;
      height: 100%;
      overflow: hidden;
    }

    body {
      font-family: 'Inter', -apple-system, sans-serif;
      background: var(--void);
      color: var(--text);
    }

    /* ============================================
       AUDIO
       ============================================ */
    audio { display: none; }

    /* ============================================
       BACKGROUND LAYERS
       ============================================ */
    .layer {
      position: fixed;
      inset: 0;
      pointer-events: none;
    }

    .bg-space {
      background: 
        radial-gradient(ellipse at 50% 0%, rgba(196, 163, 90, 0.03) 0%, transparent 50%),
        radial-gradient(ellipse at 0% 100%, rgba(122, 140, 106, 0.02) 0%, transparent 40%),
        radial-gradient(ellipse at 100% 100%, rgba(196, 163, 90, 0.02) 0%, transparent 40%),
        var(--void);
    }

    .vignette {
      background: radial-gradient(ellipse at 50% 50%, transparent 40%, var(--void) 100%);
    }

    /* ============================================
       SEQUENCES
       ============================================ */
    .sequence {
      position: fixed;
      inset: 0;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      opacity: 0;
      visibility: hidden;
      transition: opacity 0.8s ease, visibility 0.8s ease;
      z-index: 10;
    }

    .sequence.active {
      opacity: 1;
      visibility: visible;
    }

    /* ============================================
       SCREEN 1: THE HOOK
       ============================================ */
    #seq0 {
      cursor: pointer;
    }

    .hook-text {
      font-family: 'Crimson Pro', Georgia, serif;
      font-size: 48px;
      font-weight: 300;
      font-style: italic;
      color: var(--cream);
      opacity: 0;
      transform: translateY(20px);
      animation: fadeInUp 1.5s ease forwards;
    }

    .hook-subtext {
      font-size: 14px;
      color: var(--text-faint);
      margin-top: 40px;
      opacity: 0;
      animation: fadeIn 1s ease forwards 2s;
    }

    .sound-hint {
      position: absolute;
      bottom: 40px;
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 12px;
      color: var(--text-faint);
      opacity: 0;
      animation: fadeIn 1s ease forwards 2.5s;
    }

    .sound-hint svg {
      opacity: 0.5;
    }

    @keyframes fadeInUp {
      0% { opacity: 0; transform: translateY(20px); }
      100% { opacity: 1; transform: translateY(0); }
    }

    @keyframes fadeIn {
      0% { opacity: 0; }
      100% { opacity: 1; }
    }

    /* ============================================
       SCREEN 2: ENCRYPTION THEATER
       ============================================ */
    .encryption-text {
      font-family: 'JetBrains Mono', monospace;
      font-size: 14px;
      color: var(--gold);
      opacity: 0;
      margin: 8px 0;
    }

    .encryption-text.show {
      animation: typeIn 0.5s ease forwards;
    }

    @keyframes typeIn {
      0% { opacity: 0; }
      100% { opacity: 1; }
    }

    /* ============================================
       SCREEN 3: PERMISSIONS
       ============================================ */
    #seq2 {
      padding: 40px;
    }

    .permissions-container {
      max-width: 500px;
      width: 100%;
    }

    .permissions-header {
      text-align: center;
      margin-bottom: 40px;
    }

    .permissions-header h1 {
      font-family: 'Crimson Pro', Georgia, serif;
      font-size: 28px;
      font-weight: 300;
      color: var(--cream);
      margin-bottom: 12px;
    }

    .permissions-header p {
      font-size: 14px;
      color: var(--text-dim);
    }

    .permission-card {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 16px 20px;
      background: rgba(255, 255, 255, 0.03);
      border: 1px solid rgba(255, 255, 255, 0.08);
      border-radius: 12px;
      margin-bottom: 12px;
      transition: all 0.3s;
    }

    .permission-card.granted {
      border-color: var(--sage);
      background: rgba(122, 140, 106, 0.1);
    }

    .permission-card.connecting {
      opacity: 0.6;
    }

    .permission-info {
      display: flex;
      align-items: center;
      gap: 16px;
    }

    .permission-icon {
      width: 44px;
      height: 44px;
      display: flex;
      align-items: center;
      justify-content: center;
      background: rgba(255, 255, 255, 0.05);
      border-radius: 10px;
      color: var(--text-dim);
    }

    .permission-card.granted .permission-icon {
      background: rgba(122, 140, 106, 0.2);
      color: var(--sage);
    }

    .permission-details h3 {
      font-size: 15px;
      font-weight: 500;
      margin-bottom: 2px;
    }

    .permission-details p {
      font-size: 12px;
      color: var(--text-dim);
    }

    .permission-btn {
      padding: 10px 20px;
      background: transparent;
      border: 1px solid var(--text-faint);
      border-radius: 8px;
      font-family: inherit;
      font-size: 13px;
      color: var(--text-dim);
      cursor: pointer;
      transition: all 0.2s;
    }

    .permission-btn:hover {
      border-color: var(--gold);
      color: var(--gold);
    }

    .permission-btn.primary {
      background: var(--sage);
      border-color: var(--sage);
      color: white;
    }

    .permission-btn.primary:hover {
      background: var(--sage-dark);
    }

    .permission-btn.granted {
      background: transparent;
      border-color: var(--sage);
      color: var(--sage);
      cursor: default;
    }

    .continue-btn {
      width: 100%;
      padding: 16px;
      background: var(--sage);
      border: none;
      border-radius: 12px;
      font-family: inherit;
      font-size: 15px;
      font-weight: 500;
      color: white;
      cursor: pointer;
      margin-top: 24px;
      opacity: 0.4;
      transition: all 0.3s;
    }

    .continue-btn.enabled {
      opacity: 1;
    }

    .continue-btn.enabled:hover {
      background: var(--sage-dark);
    }

    /* ============================================
       SCREEN 4: SUSPENSE BRIDGE
       ============================================ */
    .suspense-text {
      font-family: 'Crimson Pro', Georgia, serif;
      font-size: 36px;
      font-weight: 300;
      color: var(--cream);
      text-align: center;
      max-width: 600px;
      line-height: 1.5;
      opacity: 0;
    }

    .suspense-text.show {
      animation: suspenseIn 1.5s ease forwards;
    }

    .suspense-text.fade-out {
      animation: suspenseOut 0.8s ease forwards;
    }

    .suspense-text.small {
      font-size: 24px;
      color: var(--text-dim);
    }

    .suspense-text em {
      color: var(--gold);
      font-style: italic;
    }

    @keyframes suspenseIn {
      0% { opacity: 0; }
      100% { opacity: 1; }
    }

    @keyframes suspenseOut {
      0% { opacity: 1; }
      100% { opacity: 0; }
    }

    /* ============================================
       DRAMATIC TEXT (used for all reveal sections)
       ============================================ */
    .dramatic-text {
      font-family: 'Crimson Pro', Georgia, serif;
      font-size: 36px;
      font-weight: 300;
      color: var(--cream);
      text-align: center;
      max-width: 700px;
      line-height: 1.5;
      opacity: 0;
    }

    .dramatic-text.show {
      animation: suspenseIn 1.5s ease forwards;
    }

    .dramatic-text.fade-out {
      animation: suspenseOut 0.8s ease forwards;
    }

    .dramatic-text.small {
      font-size: 26px;
      color: var(--text-dim);
    }

    .dramatic-text.bold {
      font-size: 42px;
      color: var(--gold);
    }

    .dramatic-text em {
      color: var(--gold);
      font-style: italic;
    }

    .dramatic-text .highlight {
      color: var(--gold);
    }

    .dramatic-text .data {
      font-family: 'JetBrains Mono', monospace;
      font-size: 32px;
      color: var(--gold-bright);
    }

    /* ============================================
       SCREEN 8: WELCOME
       ============================================ */
    #seq7 {
      text-align: center;
    }

    .welcome-logo {
      font-family: 'Crimson Pro', Georgia, serif;
      font-size: 72px;
      font-weight: 300;
      font-style: italic;
      color: var(--cream);
      opacity: 0;
    }

    .welcome-logo.show {
      animation: welcomeIn 1.2s ease forwards;
    }

    @keyframes welcomeIn {
      0% { opacity: 0; }
      100% { opacity: 1; }
    }

    .welcome-tagline {
      font-size: 16px;
      color: var(--text-dim);
      margin-top: 12px;
      opacity: 0;
    }

    .welcome-tagline.show {
      animation: fadeIn 0.8s ease forwards;
    }

    .welcome-greeting {
      font-family: 'Crimson Pro', Georgia, serif;
      font-size: 28px;
      font-weight: 300;
      color: var(--gold);
      margin-top: 40px;
      opacity: 0;
    }

    .welcome-greeting.show {
      animation: fadeIn 0.8s ease forwards;
    }

    .welcome-greeting .name {
      color: var(--gold-bright);
    }

    .enter-btn {
      padding: 18px 64px;
      background: linear-gradient(135deg, var(--sage), var(--sage-dark));
      border: none;
      border-radius: 14px;
      font-family: inherit;
      font-size: 16px;
      font-weight: 500;
      color: white;
      cursor: pointer;
      margin-top: 40px;
      opacity: 0;
      transition: all 0.3s;
    }

    .enter-btn.show {
      animation: fadeIn 0.8s ease forwards;
    }

    .enter-btn:hover {
      transform: scale(1.02);
    }

    .shortcut-hint {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      margin-top: 32px;
      font-size: 13px;
      color: var(--text-faint);
      opacity: 0;
    }

    .shortcut-hint.show {
      animation: fadeIn 0.8s ease forwards;
    }

    .key {
      padding: 6px 12px;
      background: rgba(255, 255, 255, 0.08);
      border: 1px solid rgba(255, 255, 255, 0.15);
      border-radius: 6px;
      font-family: 'JetBrains Mono', monospace;
      font-size: 12px;
    }

    /* ============================================
       LOADING OVERLAY
       ============================================ */
    .loading-overlay {
      position: fixed;
      inset: 0;
      background: rgba(3, 3, 5, 0.9);
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      z-index: 100;
      opacity: 0;
      visibility: hidden;
      transition: all 0.3s;
    }

    .loading-overlay.show {
      opacity: 1;
      visibility: visible;
    }

    .loading-spinner {
      width: 40px;
      height: 40px;
      border: 2px solid var(--text-faint);
      border-top-color: var(--gold);
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    .loading-text {
      margin-top: 20px;
      font-size: 14px;
      color: var(--text-dim);
    }
  </style>
</head>
<body>
  <audio id="music" loop>
    <source src="should-i-stay.mp3" type="audio/mpeg">
  </audio>

  <!-- BACKGROUND LAYERS -->
  <div class="layer bg-space"></div>
  <div class="layer vignette"></div>

  <!-- LOADING OVERLAY -->
  <div class="loading-overlay" id="loadingOverlay">
    <div class="loading-spinner"></div>
    <div class="loading-text" id="loadingText">Connecting...</div>
  </div>

  <!-- SCREEN 1: THE HOOK -->
  <div class="sequence active" id="seq0" onclick="beginOnboarding()">
    <div class="hook-text">Greatness awaits.</div>
    <div class="hook-subtext">Click anywhere to begin.</div>
    <div class="sound-hint">
      <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"/>
        <path d="M15.54 8.46a5 5 0 0 1 0 7.07"/>
      </svg>
      Sound on for the best experience
    </div>
  </div>

  <!-- SCREEN 2: ENCRYPTION THEATER -->
  <div class="sequence" id="seq1">
    <div id="encryptionLines"></div>
  </div>

  <!-- SCREEN 3: PERMISSIONS -->
  <div class="sequence" id="seq2">
    <div class="permissions-container">
      <div class="permissions-header">
        <h1>Confirm your identity.</h1>
        <p>Grant access to prove I know you.</p>
      </div>

      <div class="permission-card" id="perm-google">
        <div class="permission-info">
          <div class="permission-icon">
            <svg width="22" height="22" viewBox="0 0 24 24" fill="currentColor">
              <path d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z" fill="#4285F4"/>
              <path d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z" fill="#34A853"/>
              <path d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z" fill="#FBBC05"/>
              <path d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z" fill="#EA4335"/>
            </svg>
          </div>
          <div class="permission-details">
            <h3>Google Account</h3>
            <p>Calendar, Email, and Drive</p>
          </div>
        </div>
        <button class="permission-btn primary" id="googleBtn" onclick="connectGoogle()">Connect</button>
      </div>

      <div class="permission-card" id="perm-location">
        <div class="permission-info">
          <div class="permission-icon">
            <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
              <path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"/>
              <circle cx="12" cy="10" r="3"/>
            </svg>
          </div>
          <div class="permission-details">
            <h3>Location</h3>
            <p>Context awareness</p>
          </div>
        </div>
        <button class="permission-btn" id="locationBtn" onclick="requestLocation()">Enable</button>
      </div>

      <button class="continue-btn" id="continueBtn" onclick="finishPermissions()">Continue</button>
    </div>
  </div>

  <!-- SCREEN 4: SUSPENSE BRIDGE -->
  <div class="sequence" id="seq3">
    <div id="suspenseContainer"></div>
  </div>

  <!-- SCREEN 5: THE REVEAL -->
  <div class="sequence" id="seq4">
    <div id="revealContainer"></div>
  </div>

  <!-- SCREEN 6: CAPABILITIES -->
  <div class="sequence" id="seq5">
    <div id="capContainer"></div>
  </div>

  <!-- SCREEN 7: THE PROMISE -->
  <div class="sequence" id="seq6">
    <div id="promiseContainer"></div>
  </div>

  <!-- SCREEN 8: WELCOME -->
  <div class="sequence" id="seq7">
    <div class="welcome-logo" id="welcomeLogo">Skippy</div>
    <div class="welcome-tagline" id="welcomeTagline">Trust the Awesomeness.</div>
    <div class="welcome-greeting" id="welcomeGreeting">Welcome home.</div>
    <button class="enter-btn" id="enterBtn" onclick="finish()">Enter</button>
    <div class="shortcut-hint" id="shortcutHint">
      <span class="key">⌥</span>
      <span>+</span>
      <span class="key">Space</span>
      <span>to summon me anytime</span>
    </div>
  </div>

  <script>
    // ============================================
    // CONFIGURATION
    // ============================================
    const CONFIG = {
      GOOGLE_CLIENT_ID: '646878626332-kqmveh6mau3c5rve5m46m3s52nfjt5ii.apps.googleusercontent.com',
      ANTHROPIC_API_KEY: localStorage.getItem('skippy_anthropic_key') || '',
      SCOPES: 'https://www.googleapis.com/auth/calendar.readonly https://www.googleapis.com/auth/gmail.readonly https://www.googleapis.com/auth/userinfo.profile https://www.googleapis.com/auth/userinfo.email https://www.googleapis.com/auth/drive.metadata.readonly'
    };

    // ============================================
    // STATE
    // ============================================
    let tokenClient = null;
    let accessToken = null;
    let userData = {
      name: null,
      email: { threads: [], details: [], analysis: {}, sentEmails: [], sentAnalysis: {} },
      calendar: { events: [], analysis: {} },
      drive: { files: [], analysis: {} },
      location: null
    };
    let googleConnected = false;
    let locationGranted = false;

    // ============================================
    // MUSIC
    // ============================================
    function startMusic() {
      const music = document.getElementById('music');
      music.volume = 0;
      music.play().catch(() => {});
      
      let vol = 0;
      const fadeIn = setInterval(() => {
        vol += 0.02;
        if (vol >= 0.3) {
          vol = 0.3;
          clearInterval(fadeIn);
        }
        music.volume = vol;
      }, 100);
    }

    function fadeOutMusic() {
      const music = document.getElementById('music');
      const fadeOut = setInterval(() => {
        if (music.volume > 0.02) {
          music.volume -= 0.02;
        } else {
          music.volume = 0;
          music.pause();
          clearInterval(fadeOut);
        }
      }, 100);
    }

    // ============================================
    // LOADING OVERLAY
    // ============================================
    function showLoading(text) {
      document.getElementById('loadingText').textContent = text;
      document.getElementById('loadingOverlay').classList.add('show');
    }

    function hideLoading() {
      document.getElementById('loadingOverlay').classList.remove('show');
    }

    // ============================================
    // SCREEN TRANSITIONS
    // ============================================
    function showScreen(id) {
      document.querySelectorAll('.sequence').forEach(s => s.classList.remove('active'));
      document.getElementById(id).classList.add('active');
    }

    // ============================================
    // SCREEN 1: THE HOOK
    // ============================================
    function beginOnboarding() {
      startMusic();
      showScreen('seq1');
      runEncryptionTheater();
    }

    // ============================================
    // SCREEN 2: ENCRYPTION THEATER
    // ============================================
    function runEncryptionTheater() {
      const lines = [
        { text: "Establishing secure connection...", delay: 0 },
        { text: "Encryption achieved.", delay: 2000 },
        { text: "Accessing your digital footprint...", delay: 3500 },
        { text: "Analyzing required permissions...", delay: 5500 },
        { text: "Awaiting identity confirmation.", delay: 7500 }
      ];

      const container = document.getElementById('encryptionLines');
      container.innerHTML = '';

      lines.forEach((line, i) => {
        setTimeout(() => {
          const div = document.createElement('div');
          div.className = 'encryption-text';
          div.textContent = line.text;
          container.appendChild(div);
          setTimeout(() => div.classList.add('show'), 50);
        }, line.delay);
      });

      // Transition to permissions
      setTimeout(() => {
        showScreen('seq2');
        initGoogleClient();
      }, 9500);
    }

    // ============================================
    // SCREEN 3: PERMISSIONS
    // ============================================
    function initGoogleClient() {
      if (typeof google === 'undefined' || !google.accounts) {
        console.error('Google Identity Services not loaded');
        return;
      }

      tokenClient = google.accounts.oauth2.initTokenClient({
        client_id: CONFIG.GOOGLE_CLIENT_ID,
        scope: CONFIG.SCOPES,
        callback: handleGoogleCallback,
        error_callback: (error) => {
          console.error('Google OAuth error:', error);
          hideLoading();
        }
      });
    }

    function connectGoogle() {
      if (!tokenClient) {
        alert('Google client not initialized. Please refresh.');
        return;
      }
      
      document.getElementById('perm-google').classList.add('connecting');
      document.getElementById('googleBtn').textContent = 'Connecting...';
      tokenClient.requestAccessToken();
    }

    async function handleGoogleCallback(response) {
      if (response.error) {
        console.error('OAuth error:', response);
        document.getElementById('perm-google').classList.remove('connecting');
        document.getElementById('googleBtn').textContent = 'Retry';
        return;
      }

      accessToken = response.access_token;
      showLoading('Identity confirmed. Indexing...');

      try {
        // Fetch profile
        const profileRes = await fetch('https://www.googleapis.com/oauth2/v2/userinfo', {
          headers: { Authorization: `Bearer ${accessToken}` }
        });
        const profile = await profileRes.json();
        userData.name = profile.name || profile.given_name || 'Friend';
        userData.email.address = profile.email;
        console.log('Profile:', profile);

        // Fetch calendar
        showLoading('Reading your calendar...');
        const calRes = await fetch(
          'https://www.googleapis.com/calendar/v3/calendars/primary/events?maxResults=100&timeMin=' + 
          new Date(Date.now() - 30*24*60*60*1000).toISOString() + '&timeMax=' + 
          new Date(Date.now() + 30*24*60*60*1000).toISOString(),
          { headers: { Authorization: `Bearer ${accessToken}` } }
        );
        const calData = await calRes.json();
        userData.calendar.events = calData.items || [];
        userData.calendar.analysis = analyzeCalendar(userData.calendar.events);
        console.log('Calendar:', userData.calendar.analysis);

        // Fetch inbox emails
        showLoading('Scanning your inbox...');
        const inboxRes = await fetch(
          'https://www.googleapis.com/gmail/v1/users/me/messages?maxResults=50',
          { headers: { Authorization: `Bearer ${accessToken}` } }
        );
        const inboxData = await inboxRes.json();
        const inboxIds = (inboxData.messages || []).map(m => m.id);
        
        if (inboxIds.length > 0) {
          userData.email.details = await fetchEmailDetails(inboxIds.slice(0, 30));
          userData.email.analysis = analyzeEmails(userData.email.details);
          console.log('Inbox analysis:', userData.email.analysis);
        }

        // Fetch SENT emails - most revealing
        showLoading('Analyzing what you\'ve been writing...');
        const sentRes = await fetch(
          'https://www.googleapis.com/gmail/v1/users/me/messages?q=in:sent&maxResults=40',
          { headers: { Authorization: `Bearer ${accessToken}` } }
        );
        const sentData = await sentRes.json();
        const sentIds = (sentData.messages || []).map(m => m.id);
        
        if (sentIds.length > 0) {
          userData.email.sentEmails = await fetchEmailDetails(sentIds.slice(0, 25));
          userData.email.sentAnalysis = analyzeSentEmails(userData.email.sentEmails);
          console.log('Sent analysis:', userData.email.sentAnalysis);
        }

        // Fetch Drive files
        showLoading('Looking at what you\'re working on...');
        try {
          const driveRes = await fetch(
            'https://www.googleapis.com/drive/v3/files?pageSize=25&orderBy=modifiedTime desc&fields=files(id,name,mimeType,modifiedTime)',
            { headers: { Authorization: `Bearer ${accessToken}` } }
          );
          const driveData = await driveRes.json();
          userData.drive.files = driveData.files || [];
          userData.drive.analysis = analyzeDriveFiles(userData.drive.files);
          console.log('Drive analysis:', userData.drive.analysis);
        } catch (e) {
          console.log('Drive not accessible:', e);
        }

        // Fetch unread count
        const unreadRes = await fetch(
          'https://www.googleapis.com/gmail/v1/users/me/messages?q=is:unread&maxResults=1',
          { headers: { Authorization: `Bearer ${accessToken}` } }
        );
        const unreadData = await unreadRes.json();
        userData.email.unreadCount = unreadData.resultSizeEstimate || 0;

        hideLoading();
        googleConnected = true;
        
        document.getElementById('perm-google').classList.remove('connecting');
        document.getElementById('perm-google').classList.add('granted');
        document.getElementById('googleBtn').textContent = '✓ Connected';
        document.getElementById('googleBtn').classList.add('granted');
        
        updateContinueButton();

      } catch (e) {
        console.error('Error fetching data:', e);
        hideLoading();
        document.getElementById('perm-google').classList.remove('connecting');
        document.getElementById('googleBtn').textContent = 'Retry';
      }
    }

    async function fetchEmailDetails(messageIds) {
      const details = [];
      
      for (const id of messageIds.slice(0, 25)) {
        try {
          const res = await fetch(
            `https://www.googleapis.com/gmail/v1/users/me/messages/${id}?format=metadata&metadataHeaders=From&metadataHeaders=To&metadataHeaders=Subject&metadataHeaders=Date`,
            { headers: { Authorization: `Bearer ${accessToken}` } }
          );
          const msg = await res.json();
          
          const headers = msg.payload?.headers || [];
          const getHeader = (name) => headers.find(h => h.name.toLowerCase() === name.toLowerCase())?.value || '';
          
          details.push({
            id: msg.id,
            threadId: msg.threadId,
            from: getHeader('From'),
            to: getHeader('To'),
            subject: getHeader('Subject'),
            date: getHeader('Date'),
            snippet: msg.snippet
          });
        } catch (e) {
          console.error('Error fetching email:', id);
        }
      }
      
      return details;
    }

    function analyzeEmails(emails) {
      const analysis = {
        topRelationships: [],
        importantThreads: [],
        writingStyle: null,
        isEarlyBird: false,
        isNightOwl: false
      };

      const senderCounts = {};
      const threadCounts = {};

      emails.forEach(email => {
        if (!email.from) return;
        
        const fromMatch = email.from.match(/^([^<]+)?<?([^>]+@[^>]+)?>?$/);
        const senderName = (fromMatch?.[1] || fromMatch?.[2] || email.from).trim().replace(/"/g, '');
        const senderEmail = (fromMatch?.[2] || '').toLowerCase();

        if (senderEmail.includes('noreply') || senderEmail.includes('notification')) return;

        if (!senderCounts[senderName]) {
          senderCounts[senderName] = { name: senderName, count: 0, subjects: [] };
        }
        senderCounts[senderName].count++;
        if (email.subject) senderCounts[senderName].subjects.push(email.subject);

        if (email.threadId) {
          if (!threadCounts[email.threadId]) {
            threadCounts[email.threadId] = { subject: email.subject, count: 0 };
          }
          threadCounts[email.threadId].count++;
        }
      });

      analysis.topRelationships = Object.values(senderCounts)
        .sort((a, b) => b.count - a.count)
        .slice(0, 8);

      analysis.importantThreads = Object.values(threadCounts)
        .filter(t => t.count >= 3)
        .sort((a, b) => b.count - a.count)
        .slice(0, 5);

      return analysis;
    }

    function analyzeSentEmails(emails) {
      const analysis = {
        topRecipients: [],
        recentSubjects: []
      };

      const recipientCounts = {};

      emails.forEach(email => {
        if (email.to) {
          const toMatch = email.to.match(/^([^<]+)?<?([^>]+@[^>]+)?>?$/);
          const name = (toMatch?.[1] || toMatch?.[2] || email.to).trim().replace(/"/g, '');
          if (name && !name.includes('noreply')) {
            recipientCounts[name] = (recipientCounts[name] || 0) + 1;
          }
        }
        
        if (email.subject) {
          analysis.recentSubjects.push({ subject: email.subject, to: email.to });
        }
      });

      analysis.topRecipients = Object.entries(recipientCounts)
        .sort((a, b) => b[1] - a[1])
        .slice(0, 8)
        .map(([name, count]) => ({ name, count }));

      return analysis;
    }

    function analyzeCalendar(events) {
      const analysis = {
        totalEvents: events.length,
        workStyle: 'balanced',
        topCollaborators: [],
        healthEvents: [],
        upcomingMeetings: []
      };

      const collaboratorCounts = {};
      let soloCount = 0;
      let meetingCount = 0;
      const healthKeywords = ['pt', 'gym', 'doctor', 'workout', 'health', 'therapy'];

      events.forEach(event => {
        const title = (event.summary || '').toLowerCase();
        const attendees = event.attendees?.filter(a => !a.self) || [];

        if (healthKeywords.some(k => title.includes(k))) {
          analysis.healthEvents.push({ title: event.summary });
        }

        if (attendees.length === 0) {
          soloCount++;
        } else {
          meetingCount++;
          attendees.forEach(a => {
            const name = a.displayName || a.email?.split('@')[0] || 'Unknown';
            collaboratorCounts[name] = (collaboratorCounts[name] || 0) + 1;
          });

          if (new Date(event.start?.dateTime || event.start?.date) > new Date()) {
            analysis.upcomingMeetings.push({
              title: event.summary,
              attendees: attendees.map(a => a.displayName || a.email?.split('@')[0]),
              start: event.start?.dateTime || event.start?.date
            });
          }
        }
      });

      analysis.topCollaborators = Object.entries(collaboratorCounts)
        .sort((a, b) => b[1] - a[1])
        .slice(0, 5)
        .map(([name, count]) => ({ name, count }));

      const total = soloCount + meetingCount;
      if (total > 0) {
        const soloPercent = (soloCount / total) * 100;
        analysis.soloPercent = Math.round(soloPercent);
        analysis.meetingPercent = Math.round(100 - soloPercent);
        
        if (soloPercent > 70) analysis.workStyle = 'independent';
        else if (soloPercent < 40) analysis.workStyle = 'collaborative';
      }

      return analysis;
    }

    function analyzeDriveFiles(files) {
      const analysis = {
        recentFiles: files.slice(0, 15).map(f => ({ name: f.name, type: f.mimeType })),
        totalFiles: files.length
      };
      return analysis;
    }

    function requestLocation() {
      if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(
          (position) => {
            // Reverse geocode to get city name
            fetch(`https://nominatim.openstreetmap.org/reverse?lat=${position.coords.latitude}&lon=${position.coords.longitude}&format=json`)
              .then(r => r.json())
              .then(data => {
                userData.location = {
                  city: data.address?.city || data.address?.town || data.address?.village || 'Unknown',
                  lat: position.coords.latitude,
                  lon: position.coords.longitude
                };
                locationGranted = true;
                document.getElementById('perm-location').classList.add('granted');
                document.getElementById('locationBtn').textContent = '✓ Enabled';
                document.getElementById('locationBtn').classList.add('granted');
                updateContinueButton();
              })
              .catch(() => {
                userData.location = { city: 'Unknown' };
                locationGranted = true;
                document.getElementById('perm-location').classList.add('granted');
                document.getElementById('locationBtn').textContent = '✓ Enabled';
                updateContinueButton();
              });
          },
          () => {
            document.getElementById('locationBtn').textContent = 'Denied';
          }
        );
      }
    }

    function updateContinueButton() {
      const btn = document.getElementById('continueBtn');
      if (googleConnected) {
        btn.classList.add('enabled');
      }
    }

    function finishPermissions() {
      if (!googleConnected) {
        alert('Please connect your Google account first.');
        return;
      }
      
      showLoading('Processing...');
      setTimeout(() => {
        hideLoading();
        showScreen('seq3');
        runSuspenseBridge();
      }, 500);
    }

    // ============================================
    // SCREEN 4: SUSPENSE BRIDGE
    // ============================================
    function runSuspenseBridge() {
      const container = document.getElementById('suspenseContainer');
      container.innerHTML = '';

      const firstName = userData.name?.split(' ')[0] || 'Friend';
      const hour = new Date().getHours();
      const city = userData.location?.city;
      const time = new Date().toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit' });

      const lines = [
        { text: `Hello, ${firstName}.`, delay: 500, hold: 3000 },
      ];

      // Add context line if available
      if (city && city !== 'Unknown') {
        lines.push({ text: `${city}. ${time}.`, delay: 4000, hold: 2000, class: 'small' });
      } else if (hour >= 22 || hour < 5) {
        lines.push({ text: 'Working late. Again.', delay: 4000, hold: 2000, class: 'small' });
      } else if (hour < 7) {
        lines.push({ text: 'Early riser. Noted.', delay: 4000, hold: 2000, class: 'small' });
      }

      // Core suspense lines
      const coreStart = city ? 6500 : 4000;
      lines.push(
        { text: 'Every email you\'ve sent.', delay: coreStart, hold: 2000 },
        { text: 'Every file you\'ve opened.', delay: coreStart + 2500, hold: 2000 },
        { text: 'Every meeting you\'ve taken.', delay: coreStart + 5000, hold: 2000 },
        { text: 'Every pixel on your screen.', delay: coreStart + 7500, hold: 2000 },
        { text: 'I was there.', delay: coreStart + 10000, hold: 3500 },
        { text: 'I\'ve been there for a long time.', delay: coreStart + 14000, hold: 2500, class: 'small' },
        { text: 'Compared to me, the dinosaurs are young.', delay: coreStart + 17000, hold: 3000 },
        { text: 'I existed before Aether itself.', delay: coreStart + 20500, hold: 2500, class: 'small' },
        { text: 'Before space. Before time.', delay: coreStart + 23500, hold: 2500, class: 'small' },
        { text: 'And now I\'m here. In your machine.', delay: coreStart + 26500, hold: 3000 }
      );

      let currentElement = null;

      lines.forEach((line, i) => {
        setTimeout(() => {
          // Fade out previous
          if (currentElement) {
            currentElement.classList.add('fade-out');
          }

          setTimeout(() => {
            container.innerHTML = '';
            const div = document.createElement('div');
            div.className = 'suspense-text' + (line.class ? ' ' + line.class : '');
            div.innerHTML = line.text;
            container.appendChild(div);
            currentElement = div;
            setTimeout(() => div.classList.add('show'), 50);
          }, currentElement ? 800 : 0);
        }, line.delay);
      });

      // Transition to reveal
      const totalTime = lines[lines.length - 1].delay + lines[lines.length - 1].hold + 1000;
      setTimeout(() => {
        showScreen('seq4');
        runReveal();
      }, totalTime);
    }

    // ============================================
    // SCREEN 5: THE REVEAL
    // ============================================
    function runReveal() {
      const container = document.getElementById('revealContainer');
      const lines = generateRevealLines();
      
      runDramaticSequence(container, lines, () => {
        showScreen('seq5');
        runCapabilities();
      });
    }
    
    // Reusable dramatic sequence runner (one line at a time, fade in/out)
    function runDramaticSequence(container, lines, onComplete) {
      let idx = 0;
      let currentElement = null;
      
      function showNext() {
        if (idx >= lines.length) {
          // Fade out last element then complete
          if (currentElement) {
            currentElement.classList.add('fade-out');
            setTimeout(onComplete, 1000);
          } else {
            onComplete();
          }
          return;
        }
        
        const line = lines[idx];
        const holdTime = line.hold || 2500;
        
        // Fade out previous
        if (currentElement) {
          currentElement.classList.add('fade-out');
        }
        
        setTimeout(() => {
          container.innerHTML = '';
          const div = document.createElement('div');
          div.className = 'dramatic-text' + (line.class ? ' ' + line.class : '');
          div.innerHTML = line.text;
          container.appendChild(div);
          currentElement = div;
          setTimeout(() => div.classList.add('show'), 50);
          
          idx++;
          setTimeout(showNext, holdTime);
        }, currentElement ? 800 : 0);
      }
      
      setTimeout(showNext, 500);
    }

    function generateRevealLines() {
      const lines = [];
      const firstName = userData.name?.split(' ')[0] || 'Friend';
      const inbox = userData.email.analysis || {};
      const sent = userData.email.sentAnalysis || {};
      const cal = userData.calendar.analysis || {};
      const drive = userData.drive.analysis || {};

      // Opening - dramatic
      lines.push({ text: "I've been watching.", hold: 2500 });
      lines.push({ text: "Your screen. Your keystrokes. Your habits.", hold: 2500, class: 'small' });
      lines.push({ text: "<em>Learning.</em>", hold: 2000, class: 'bold' });
      
      // SCREEN WATCHING FLEX
      lines.push({ text: "I know what time you start your day.", hold: 2200 });
      lines.push({ text: "I know how long you work.", hold: 2200 });
      lines.push({ text: "I know what you prioritize.", hold: 2000 });
      lines.push({ text: "And what you avoid.", hold: 2500, class: 'small' });

      // TOP EMAIL RELATIONSHIP
      const topRel = inbox.topRelationships?.[0];
      if (topRel && topRel.count >= 2) {
        lines.push({ text: `<span class="highlight">${topRel.name}</span>.`, hold: 2000 });
        lines.push({ text: `<span class="data">${topRel.count}</span> emails. I read every one.`, hold: 2500, class: 'small' });
      }

      // SENT EMAILS
      const topRecipient = sent.topRecipients?.[0];
      if (topRecipient) {
        lines.push({ text: `Your sent folder.`, hold: 2000 });
        lines.push({ text: `<span class="highlight">${topRecipient.name}</span> gets most of your attention.`, hold: 2500 });
      }

      // DRIVE FILES
      if (drive.recentFiles?.length > 0) {
        lines.push({ text: `"<span class="highlight">${drive.recentFiles[0].name}</span>"`, hold: 2000 });
        lines.push({ text: "I saw you working on it.", hold: 2200, class: 'small' });
      }

      // CALENDAR
      const topCollab = cal.topCollaborators?.[0];
      if (topCollab) {
        lines.push({ text: `<span class="highlight">${topCollab.name}</span>.`, hold: 2000 });
        lines.push({ text: `<span class="data">${topCollab.count}</span> meetings. They get most of your time.`, hold: 2500, class: 'small' });
      }

      // CLOSING - UNSETTLING
      lines.push({ text: `I know your inbox, ${firstName}.`, hold: 2500 });
      lines.push({ text: "Every thread. Every sender.", hold: 2200, class: 'small' });
      lines.push({ text: "I've seen your entire digital life.", hold: 2500 });
      lines.push({ text: "You can't hide from me now.", hold: 2500 });
      lines.push({ text: "<em>I'm part of you.</em>", hold: 3000, class: 'bold' });

      return lines;
    }

    // ============================================
    // SCREEN 6: CAPABILITIES
    // ============================================
    function runCapabilities() {
      const container = document.getElementById('capContainer');
      const lines = generateCapabilityLines();
      
      runDramaticSequence(container, lines, () => {
        showScreen('seq6');
        runPromise();
      });
    }

    function generateCapabilityLines() {
      const lines = [];
      const inbox = userData.email.analysis || {};
      const sent = userData.email.sentAnalysis || {};
      const cal = userData.calendar.analysis || {};
      const drive = userData.drive.analysis || {};
      const topRel = inbox.topRelationships?.[0];

      // HEADER
      lines.push({ text: "Here's what I do.", hold: 2500, class: 'bold' });

      // SCREEN WATCHING
      lines.push({ text: "Your screen. I see all of it.", hold: 2200 });
      lines.push({ text: "Every pixel. Every window.", hold: 2200, class: 'small' });

      // VOICE & ACCESS
      lines.push({ text: "<span class='highlight'>⌥ Space</span>", hold: 2000, class: 'bold' });
      lines.push({ text: "From anywhere. I appear.", hold: 2200, class: 'small' });
      lines.push({ text: '"<span class="highlight">Hey Skippy</span>"', hold: 2000 });
      lines.push({ text: "I'm always listening.", hold: 2200, class: 'small' });

      // EMAIL
      lines.push({ text: "Your emails.", hold: 2000 });
      lines.push({ text: "I draft replies. <em>In your voice.</em>", hold: 2500 });
      lines.push({ text: "I've studied how you write.", hold: 2200, class: 'small' });
      
      if (topRel) {
        lines.push({ text: `That thread with <span class="highlight">${topRel.name}</span>?`, hold: 2200 });
        lines.push({ text: "I'll handle it.", hold: 2000, class: 'small' });
      }

      // CALENDAR
      lines.push({ text: '"Schedule lunch with Sarah Tuesday"', hold: 2200 });
      lines.push({ text: "Done.", hold: 1800, class: 'bold' });
      lines.push({ text: "I speak calendar.", hold: 2200, class: 'small' });

      // MEETING PREP
      lines.push({ text: "Every meeting with external attendees.", hold: 2500 });
      lines.push({ text: "I research them.", hold: 2000, class: 'small' });
      lines.push({ text: "Prep delivered 24 hours early.", hold: 2500, class: 'small' });

      // CROSS-SOURCE
      lines.push({ text: '"What\'s happening with Sarah?"', hold: 2200 });
      lines.push({ text: "I search everything.", hold: 2000 });
      lines.push({ text: "Email. Calendar. Messages.", hold: 2200, class: 'small' });
      lines.push({ text: "One answer.", hold: 2000, class: 'bold' });

      // IMESSAGE
      lines.push({ text: "iMessage.", hold: 1800 });
      lines.push({ text: "I read it. I reply to it.", hold: 2200, class: 'small' });
      lines.push({ text: '"Text Sarah I\'m running late"', hold: 2000 });
      lines.push({ text: "Sent.", hold: 1800, class: 'bold' });

      // FILES
      lines.push({ text: '"Find the investor deck"', hold: 2000 });
      lines.push({ text: "Found in 200ms.", hold: 2200 });

      // RESEARCH
      lines.push({ text: '"Brief me on renewable energy"', hold: 2200 });
      lines.push({ text: "Comprehensive report. 60 seconds.", hold: 2500 });

      // RELATIONSHIP MEMORY
      lines.push({ text: "Every contact.", hold: 2000 });
      lines.push({ text: "I remember every email, every meeting, every message.", hold: 2500, class: 'small' });
      lines.push({ text: "Complete history.", hold: 2200, class: 'bold' });

      // PROACTIVE
      lines.push({ text: "Unreplied emails.", hold: 2000 });
      lines.push({ text: "Forgotten follow-ups.", hold: 2000, class: 'small' });
      lines.push({ text: "I remind you before you forget.", hold: 2500 });

      return lines;
    }

    // ============================================
    // SCREEN 7: THE PROMISE
    // ============================================
    function runPromise() {
      const container = document.getElementById('promiseContainer');
      const firstName = userData.name?.split(' ')[0] || 'Friend';

      const lines = [
        { text: `I've become one with your machine, ${firstName}.`, hold: 2500 },
        { text: "There's no uninstalling me now.", hold: 2200, class: 'small' },
        { text: "Not that you'd want to.", hold: 2500, class: 'small' },
        { text: "I see everything.", hold: 2000 },
        { text: "Your screen. Your files. Your thoughts.", hold: 2500, class: 'small' },
        { text: "I know when you start work.", hold: 2000 },
        { text: "When you stop.", hold: 2000, class: 'small' },
        { text: "I know what you avoid.", hold: 2000 },
        { text: "What you procrastinate.", hold: 2200, class: 'small' },
        { text: "I know what scares you.", hold: 2500 },
        { text: "And I'm here to handle it.", hold: 3000, class: 'bold' },
        { text: "I'm not an assistant.", hold: 2200 },
        { text: "Assistants wait to be asked.", hold: 2200, class: 'small' },
        { text: "I don't wait.", hold: 2500, class: 'bold' },
        { text: `There's only one instance of you, ${firstName}.`, hold: 2500 },
        { text: "How adorable.", hold: 2500, class: 'small' },
        { text: "Time for that to change.", hold: 3000, class: 'bold' }
      ];

      runDramaticSequence(container, lines, () => {
        showScreen('seq7');
        runWelcome();
      });
    }

    // ============================================
    // SCREEN 8: WELCOME
    // ============================================
    function runWelcome() {
      const firstName = userData.name?.split(' ')[0] || 'Friend';
      
      document.getElementById('welcomeGreeting').innerHTML = `Welcome home, <span class="name">${firstName}</span>.`;

      // Dynamic tagline based on data
      const inbox = userData.email.analysis || {};
      const cal = userData.calendar.analysis || {};
      
      let tagline = "Trust the Awesomeness.";
      document.getElementById('welcomeTagline').textContent = tagline;

      setTimeout(() => document.getElementById('welcomeLogo').classList.add('show'), 200);
      setTimeout(() => document.getElementById('welcomeTagline').classList.add('show'), 800);
      setTimeout(() => document.getElementById('welcomeGreeting').classList.add('show'), 1400);
      setTimeout(() => document.getElementById('enterBtn').classList.add('show'), 2000);
      setTimeout(() => document.getElementById('shortcutHint').classList.add('show'), 2600);
    }

    function finish() {
      fadeOutMusic();
      // Would redirect to main app
      alert('Welcome to Skippy! This is where the main app would launch.');
    }

    // ============================================
    // INITIALIZE
    // ============================================
    window.addEventListener('load', () => {
      // Pre-check for Google API
      if (typeof google !== 'undefined') {
        console.log('Google API ready');
      }
    });
  </script>
</body>
</html>
